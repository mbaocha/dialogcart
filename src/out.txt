======================================================================
CORE SESSION FOLLOW-UP TEST SUITE
======================================================================
Total scenarios: 81

============================================================
Scenario 1: service_to_date_to_time
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book a haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_001_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_001_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: tomorrow ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_001_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_001_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_001_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14'} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_001_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 11am ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_001_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_001_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '11:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=11:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_001_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=11:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_001_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_001_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14",
        "time": "11:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "11:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "11:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '11:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_001_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14",
    "time": "11:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 2: service_to_date_to_time_massage
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book massage ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_002_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Persisting to session: slots={'service_id': 'massage'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_002_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: this friday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_002_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_002_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-16'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Merge: session_slots={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-16'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'massage', 'date': '2026-01-16'}
  effective_collected_slots (after filter)={'service_id': 'massage', 'date': '2026-01-16'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'date': '2026-01-16'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-16'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-16'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_002_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'massage', 'date': '2026-01-16'} effective_response_slots={'service_id': 'massage', 'date': '2026-01-16'}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage",
        "date": "2026-01-16"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "date": "2026-01-16"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "massage",
      "date": "2026-01-16"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'massage', 'date': '2026-01-16'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'massage'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'massage', 'date': '2026-01-16'}}
  slots from merged_luma_response={'service_id': 'massage', 'date': '2026-01-16'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_002_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-16"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 3pm ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_002_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-16"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_002_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '15:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'date': '2026-01-16'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=15:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_002_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=15:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_002_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_002_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True} effective_response_slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage",
        "date": "2026-01-16",
        "time": "15:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "date": "2026-01-16",
      "time": "15:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "massage",
      "date": "2026-01-16",
      "time": "15:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'massage'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00'}}
  slots from merged_luma_response={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'date': '2026-01-16', 'time': '15:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_002_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-16",
    "time": "15:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 3: service_to_date_to_time_facial
============================================================
Domain: service, Turns: 3

--- Turn 1/3: schedule facial ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_003_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'facial'}
  effective_collected_slots (after filter)={'service_id': 'facial'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial'}
  effective_response.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "facial",
            "text": "facial"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "facial"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "facial"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'facial', 'text': 'facial'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'facial'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'facial'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'facial'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'facial'}
[DEBUG] Persisting to session: slots={'service_id': 'facial'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_003_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next monday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_003_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_003_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-26'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'facial'}
[DEBUG] Merge: session_slots={'service_id': 'facial'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'facial', 'date': '2026-01-26'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'facial', 'date': '2026-01-26'}
  effective_collected_slots (after filter)={'service_id': 'facial', 'date': '2026-01-26'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'date': '2026-01-26'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'date': '2026-01-26'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'date': '2026-01-26'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_003_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'facial', 'date': '2026-01-26'} effective_response_slots={'service_id': 'facial', 'date': '2026-01-26'}
  effective_response_booking_services=[{'text': 'facial'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "facial",
        "date": "2026-01-26"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "date": "2026-01-26"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "facial",
      "date": "2026-01-26"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'facial', 'date': '2026-01-26'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'facial'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'facial', 'date': '2026-01-26'}}
  slots from merged_luma_response={'service_id': 'facial', 'date': '2026-01-26'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_003_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "date": "2026-01-26"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 10am ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_003_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "date": "2026-01-26"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_003_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '10:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Merge: session_slots={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial', 'date': '2026-01-26'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=10:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_003_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=10:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_003_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_003_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True} effective_response_slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'facial'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "facial",
        "date": "2026-01-26",
        "time": "10:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "date": "2026-01-26",
      "time": "10:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "facial",
      "date": "2026-01-26",
      "time": "10:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'facial'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00'}}
  slots from merged_luma_response={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'date': '2026-01-26', 'time': '10:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_003_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "date": "2026-01-26",
    "time": "10:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 4: service_to_date_to_time_waxing
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book waxing ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_004_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'waxing'}
  effective_collected_slots (after filter)={'service_id': 'waxing'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing'}
  effective_response.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing'}
  extraction_result.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "waxing"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "waxing",
            "text": "waxing"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "waxing"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "waxing"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'waxing', 'text': 'waxing'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'waxing'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'waxing'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'waxing'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'waxing'}
[DEBUG] Persisting to session: slots={'service_id': 'waxing'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_004_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: saturday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_004_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_004_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-17'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'waxing'}
[DEBUG] Merge: session_slots={'service_id': 'waxing'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'waxing'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'waxing', 'date': '2026-01-17'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Promotion: promoted_slots={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'waxing', 'date': '2026-01-17'}
  effective_collected_slots (after filter)={'service_id': 'waxing', 'date': '2026-01-17'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing', 'date': '2026-01-17'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date': '2026-01-17'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date': '2026-01-17'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'waxing'}]
[PLAN_STATUS] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_004_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'waxing', 'date': '2026-01-17'} effective_response_slots={'service_id': 'waxing', 'date': '2026-01-17'}
  effective_response_booking_services=[{'text': 'waxing'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "waxing",
        "date": "2026-01-17"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "waxing"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "waxing",
      "date": "2026-01-17"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "waxing",
      "date": "2026-01-17"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'waxing', 'date': '2026-01-17'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'waxing'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'waxing', 'date': '2026-01-17'}}
  slots from merged_luma_response={'service_id': 'waxing', 'date': '2026-01-17'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Persisting to session: slots={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_004_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date": "2026-01-17"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 2pm ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_004_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date": "2026-01-17"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_004_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '14:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Merge: session_slots={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'waxing', 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=14:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_004_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=14:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'waxing'}]
[PLAN_STATUS] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_004_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_004_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True} effective_response_slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'waxing'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "waxing",
        "date": "2026-01-17",
        "time": "14:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "waxing"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "waxing",
      "date": "2026-01-17",
      "time": "14:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "waxing",
      "date": "2026-01-17",
      "time": "14:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'waxing'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00'}}
  slots from merged_luma_response={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'waxing', 'date': '2026-01-17', 'time': '14:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_004_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date": "2026-01-17",
    "time": "14:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 5: service_to_date_to_time_manicure
============================================================
Domain: service, Turns: 3

--- Turn 1/3: i need a manicure ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_005_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'manicure'}
  effective_collected_slots (after filter)={'service_id': 'manicure'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'manicure'}
  effective_response.context={'services': [{'canonical': 'manicure', 'text': 'manicure'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure'}
  extraction_result.context={'services': [{'canonical': 'manicure', 'text': 'manicure'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "manicure",
          "text": "manicure"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "manicure"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "manicure",
            "text": "manicure"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "manicure",
          "text": "manicure"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "manicure"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "manicure"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'manicure', 'text': 'manicure'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'manicure'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'manicure'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'manicure'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'manicure'}
[DEBUG] Persisting to session: slots={'service_id': 'manicure'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_005_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next week ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_005_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_005_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'manicure'}
[DEBUG] Merge: session_slots={'service_id': 'manicure'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'manicure'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED date from date_range: 2026-01-19
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date']
  promoted_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_collected_slots (after filter)={'service_id': 'manicure', 'date': '2026-01-19'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date'], promoted_slots=['service_id', 'date_range', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date_range', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date_range', 'date'], booking_services=[{'text': 'manicure'}]
[PLAN_STATUS] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_005_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'} effective_response_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_response_booking_services=[{'text': 'manicure'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "manicure",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        },
        "date": "2026-01-19"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date_range",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "manicure"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "manicure",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      },
      "date": "2026-01-19"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "manicure",
      "date": "2026-01-19"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'manicure'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'manicure', 'date': '2026-01-19'}}
  slots from merged_luma_response={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  slots.keys()=['service_id', 'date_range', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date'] = {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Persisting to session: slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_005_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 4pm ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_005_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_005_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '16:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date_range', 'date'] = {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: session_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range', 'date', 'time'] = {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date_range', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'manicure', 'date': '2026-01-19', 'time': '16:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  slots.time=16:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_005_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  merged_session_slots.time=16:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'manicure'}]
[PLAN_STATUS] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_005_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_005_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True} effective_response_slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'manicure'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "manicure",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        },
        "date": "2026-01-19",
        "time": "16:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "manicure"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "manicure",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      },
      "date": "2026-01-19",
      "time": "16:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "manicure",
      "date": "2026-01-19",
      "time": "16:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'manicure'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'manicure', 'date': '2026-01-19', 'time': '16:00'}}
  slots from merged_luma_response={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date', 'time', 'has_datetime'] = {'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'manicure', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '16:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_005_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19",
    "time": "16:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 6: service_to_date_to_time_pedicure
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book pedicure ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_006_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'pedicure'}
  effective_collected_slots (after filter)={'service_id': 'pedicure'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'pedicure'}
  effective_response.context={'services': [{'canonical': 'pedicure', 'text': 'pedicure'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure'}
  extraction_result.context={'services': [{'canonical': 'pedicure', 'text': 'pedicure'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "pedicure",
          "text": "pedicure"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "pedicure"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "pedicure",
            "text": "pedicure"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "pedicure",
          "text": "pedicure"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "pedicure"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "pedicure"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'pedicure', 'text': 'pedicure'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'pedicure'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'pedicure'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'pedicure'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'pedicure'}
[DEBUG] Persisting to session: slots={'service_id': 'pedicure'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_006_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: this weekend ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_006_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_006_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'pedicure'}
[DEBUG] Merge: session_slots={'service_id': 'pedicure'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'pedicure'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED date from date_range: 2026-01-17
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date']
  promoted_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  effective_collected_slots (after filter)={'service_id': 'pedicure', 'date': '2026-01-17'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date'], promoted_slots=['service_id', 'date_range', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date_range', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date_range', 'date'], booking_services=[{'text': 'pedicure'}]
[PLAN_STATUS] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_006_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'} effective_response_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  effective_response_booking_services=[{'text': 'pedicure'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "pedicure",
        "date_range": {
          "end": "2026-01-18",
          "start": "2026-01-17"
        },
        "date": "2026-01-17"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date_range",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "pedicure"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "pedicure",
      "date_range": {
        "end": "2026-01-18",
        "start": "2026-01-17"
      },
      "date": "2026-01-17"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "pedicure",
      "date": "2026-01-17"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'pedicure'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'pedicure', 'date': '2026-01-17'}}
  slots from merged_luma_response={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
  slots.keys()=['service_id', 'date_range', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date'] = {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Persisting to session: slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_006_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure",
    "date_range": {
      "end": "2026-01-18",
      "start": "2026-01-17"
    },
    "date": "2026-01-17"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 11am ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_006_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure",
    "date_range": {
      "end": "2026-01-18",
      "start": "2026-01-17"
    },
    "date": "2026-01-17"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_006_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '11:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date_range', 'date'] = {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Merge: session_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range', 'date', 'time'] = {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date_range', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'pedicure', 'date': '2026-01-17', 'time': '11:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  slots.time=11:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_006_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  merged_session_slots.time=11:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'pedicure'}]
[PLAN_STATUS] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_006_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_006_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True} effective_response_slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'pedicure'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "pedicure",
        "date_range": {
          "end": "2026-01-18",
          "start": "2026-01-17"
        },
        "date": "2026-01-17",
        "time": "11:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "pedicure"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "pedicure",
      "date_range": {
        "end": "2026-01-18",
        "start": "2026-01-17"
      },
      "date": "2026-01-17",
      "time": "11:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "pedicure",
      "date": "2026-01-17",
      "time": "11:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'pedicure'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'pedicure', 'date': '2026-01-17', 'time': '11:00'}}
  slots from merged_luma_response={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date', 'time', 'has_datetime'] = {'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'pedicure', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'time': '11:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_006_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure",
    "date_range": {
      "end": "2026-01-18",
      "start": "2026-01-17"
    },
    "date": "2026-01-17",
    "time": "11:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 7: service_to_date_to_time_eyebrow
============================================================
Domain: service, Turns: 3

--- Turn 1/3: schedule eyebrow ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_007_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'eyebrow'}
  effective_collected_slots (after filter)={'service_id': 'eyebrow'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'eyebrow'}
  effective_response.context={'services': [{'canonical': 'eyebrow', 'text': 'eyebrow'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow'}
  extraction_result.context={'services': [{'canonical': 'eyebrow', 'text': 'eyebrow'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "eyebrow",
          "text": "eyebrow"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "eyebrow"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "eyebrow",
            "text": "eyebrow"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "eyebrow",
          "text": "eyebrow"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "eyebrow"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "eyebrow"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'eyebrow', 'text': 'eyebrow'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'eyebrow'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'eyebrow'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'eyebrow'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'eyebrow'}
[DEBUG] Persisting to session: slots={'service_id': 'eyebrow'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_007_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "eyebrow"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: wednesday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_007_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "eyebrow"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_007_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'eyebrow'}
[DEBUG] Merge: session_slots={'service_id': 'eyebrow'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'eyebrow'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'eyebrow', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
  effective_collected_slots (after filter)={'service_id': 'eyebrow', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'eyebrow'}]
[PLAN_STATUS] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_007_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'eyebrow', 'date': '2026-01-14'} effective_response_slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
  effective_response_booking_services=[{'text': 'eyebrow'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "eyebrow"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "eyebrow",
        "date": "2026-01-14"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "eyebrow"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "eyebrow",
      "date": "2026-01-14"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "eyebrow"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "eyebrow",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'eyebrow', 'date': '2026-01-14'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'eyebrow'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'eyebrow', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'eyebrow', 'date': '2026-01-14'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_007_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "eyebrow",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 1pm ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_007_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "eyebrow",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_007_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '13:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Merge: session_slots={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'eyebrow', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=13:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_007_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=13:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'eyebrow'}]
[PLAN_STATUS] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_007_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_007_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True} effective_response_slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'eyebrow'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "eyebrow"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "eyebrow",
        "date": "2026-01-14",
        "time": "13:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "eyebrow"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "eyebrow",
      "date": "2026-01-14",
      "time": "13:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "eyebrow"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "eyebrow",
      "date": "2026-01-14",
      "time": "13:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'eyebrow'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00'}}
  slots from merged_luma_response={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'eyebrow', 'date': '2026-01-14', 'time': '13:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_007_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "eyebrow",
    "date": "2026-01-14",
    "time": "13:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 8: service_to_date_to_time_coloring
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book coloring ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_008_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'coloring'}
  effective_collected_slots (after filter)={'service_id': 'coloring'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'coloring'}
  effective_response.context={'services': [{'canonical': 'coloring', 'text': 'coloring'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring'}
  extraction_result.context={'services': [{'canonical': 'coloring', 'text': 'coloring'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "coloring",
          "text": "coloring"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "coloring"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "coloring",
            "text": "coloring"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "coloring",
          "text": "coloring"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "coloring"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "coloring"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'coloring', 'text': 'coloring'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'coloring'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'coloring'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'coloring'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'coloring'}
[DEBUG] Persisting to session: slots={'service_id': 'coloring'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_008_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "coloring"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next thursday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_008_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "coloring"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_008_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-22'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'coloring'}
[DEBUG] Merge: session_slots={'service_id': 'coloring'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'coloring'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'coloring', 'date': '2026-01-22'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Promotion: promoted_slots={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'coloring', 'date': '2026-01-22'}
  effective_collected_slots (after filter)={'service_id': 'coloring', 'date': '2026-01-22'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'coloring', 'date': '2026-01-22'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring', 'date': '2026-01-22'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring', 'date': '2026-01-22'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'coloring'}]
[PLAN_STATUS] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_008_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'coloring', 'date': '2026-01-22'} effective_response_slots={'service_id': 'coloring', 'date': '2026-01-22'}
  effective_response_booking_services=[{'text': 'coloring'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "coloring"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "coloring",
        "date": "2026-01-22"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "coloring"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "coloring",
      "date": "2026-01-22"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "coloring"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "coloring",
      "date": "2026-01-22"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'coloring', 'date': '2026-01-22'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'coloring'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'coloring', 'date': '2026-01-22'}}
  slots from merged_luma_response={'service_id': 'coloring', 'date': '2026-01-22'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Persisting to session: slots={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_008_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "coloring",
    "date": "2026-01-22"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 9am ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_008_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "coloring",
    "date": "2026-01-22"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_008_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '09:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Merge: session_slots={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'coloring', 'date': '2026-01-22'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=09:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_008_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=09:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'coloring'}]
[PLAN_STATUS] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_008_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_008_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True} effective_response_slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'coloring'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "coloring"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "coloring",
        "date": "2026-01-22",
        "time": "09:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "coloring"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "coloring",
      "date": "2026-01-22",
      "time": "09:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "coloring"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "coloring",
      "date": "2026-01-22",
      "time": "09:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'coloring'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00'}}
  slots from merged_luma_response={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'coloring', 'date': '2026-01-22', 'time': '09:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_008_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "coloring",
    "date": "2026-01-22",
    "time": "09:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 9: service_to_date_to_time_highlight
============================================================
Domain: service, Turns: 3

--- Turn 1/3: i want highlights ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_009_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'highlight'}
  effective_collected_slots (after filter)={'service_id': 'highlight'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'highlight'}
  effective_response.context={'services': [{'canonical': 'highlight', 'text': 'highlight'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight'}
  extraction_result.context={'services': [{'canonical': 'highlight', 'text': 'highlight'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "highlight",
          "text": "highlight"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "highlight"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "highlight",
            "text": "highlight"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "highlight",
          "text": "highlight"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "highlight"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "highlight"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'highlight', 'text': 'highlight'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'highlight'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'highlight'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'highlight'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'highlight'}
[DEBUG] Persisting to session: slots={'service_id': 'highlight'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_009_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "highlight"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next friday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_009_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "highlight"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_009_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-23'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'highlight'}
[DEBUG] Merge: session_slots={'service_id': 'highlight'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'highlight'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'highlight', 'date': '2026-01-23'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Promotion: promoted_slots={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_collected_slots (after filter)={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'highlight'}]
[PLAN_STATUS] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_009_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'highlight', 'date': '2026-01-23'} effective_response_slots={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_response_booking_services=[{'text': 'highlight'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "highlight"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "highlight",
        "date": "2026-01-23"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "highlight"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "highlight",
      "date": "2026-01-23"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "highlight"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "highlight",
      "date": "2026-01-23"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'highlight', 'date': '2026-01-23'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'highlight'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'highlight', 'date': '2026-01-23'}}
  slots from merged_luma_response={'service_id': 'highlight', 'date': '2026-01-23'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_009_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "highlight",
    "date": "2026-01-23"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: noon ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_009_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "highlight",
    "date": "2026-01-23"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_009_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Merge: session_slots={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'highlight', 'date': '2026-01-23'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CREATE_APPOINTMENT, session_intent=CREATE_APPOINTMENT, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: ['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[INFORMATIONAL_TURN] Preserved missing_slots: ['time']

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_009_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'highlight', 'date': '2026-01-23'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'highlight'}]
[PLAN_STATUS] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_009_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_009_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'highlight', 'date': '2026-01-23'} effective_response_slots={'service_id': 'highlight', 'date': '2026-01-23'}
  effective_response_booking_services=[{'text': 'highlight'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "highlight"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "highlight",
        "date": "2026-01-23"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "highlight"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {
      "service_id": "highlight",
      "date": "2026-01-23"
    },
    "booking": {
      "services": [
        {
          "text": "highlight"
        }
      ]
    },
    "awaiting_slot": "time",
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "highlight",
      "date": "2026-01-23"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {'service_id': 'highlight', 'date': '2026-01-23'}, 'booking': {'services': [{'text': 'highlight'}]}, 'awaiting_slot': 'time', 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'highlight', 'date': '2026-01-23'}}
  slots from merged_luma_response={'service_id': 'highlight', 'date': '2026-01-23'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots={'service_id': 'highlight', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_009_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "highlight",
    "date": "2026-01-23"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

 Scenario 9 passed

============================================================
Scenario 10: service_to_date_to_time_cut
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book a cut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_010_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'cut'}
  effective_collected_slots (after filter)={'service_id': 'cut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'cut'}
  effective_response.context={'services': [{'canonical': 'cut', 'text': 'cut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut'}
  extraction_result.context={'services': [{'canonical': 'cut', 'text': 'cut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "cut",
          "text": "cut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "cut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "cut",
            "text": "cut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "cut",
          "text": "cut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "cut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "cut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'cut', 'text': 'cut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'cut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'cut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'cut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'cut'}
[DEBUG] Persisting to session: slots={'service_id': 'cut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_010_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "cut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: tuesday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_010_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "cut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_010_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-20'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'cut'}
[DEBUG] Merge: session_slots={'service_id': 'cut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'cut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'cut', 'date': '2026-01-20'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Promotion: promoted_slots={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'cut', 'date': '2026-01-20'}
  effective_collected_slots (after filter)={'service_id': 'cut', 'date': '2026-01-20'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'cut', 'date': '2026-01-20'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut', 'date': '2026-01-20'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut', 'date': '2026-01-20'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'cut'}]
[PLAN_STATUS] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_010_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'cut', 'date': '2026-01-20'} effective_response_slots={'service_id': 'cut', 'date': '2026-01-20'}
  effective_response_booking_services=[{'text': 'cut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "cut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "cut",
        "date": "2026-01-20"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "cut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "cut",
      "date": "2026-01-20"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "cut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "cut",
      "date": "2026-01-20"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'cut', 'date': '2026-01-20'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'cut'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'cut', 'date': '2026-01-20'}}
  slots from merged_luma_response={'service_id': 'cut', 'date': '2026-01-20'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Persisting to session: slots={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_010_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "cut",
    "date": "2026-01-20"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 5pm ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 3] user_id=test_session_010_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "cut",
    "date": "2026-01-20"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_010_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '17:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Merge: session_slots={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'cut', 'date': '2026-01-20'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=17:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_010_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=17:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'cut'}]
[PLAN_STATUS] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_010_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_010_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True} effective_response_slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'cut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "cut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "cut",
        "date": "2026-01-20",
        "time": "17:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "cut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "cut",
      "date": "2026-01-20",
      "time": "17:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "cut"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "cut",
      "date": "2026-01-20",
      "time": "17:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'cut'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00'}}
  slots from merged_luma_response={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'cut', 'date': '2026-01-20', 'time': '17:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_010_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "cut",
    "date": "2026-01-20",
    "time": "17:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 11: service_to_time_to_date
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book massage at 2pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_011_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}, 'time_mode': 'exact', 'time_ref': '2 pm'}
  context.time_constraint={'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}
  context.time_ref=2 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '14:00'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}, 'time_mode': 'exact', 'time_ref': '2 pm'}
  context.time_constraint={'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}
  context.time_ref=2 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=14:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '14:00'}
  extraction_result.context.time_constraint={'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=2 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=14:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_011_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_011_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "14:00",
        "label": null,
        "mode": "exact",
        "start": "14:00"
      },
      "time_mode": "exact",
      "time_ref": "2 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "14:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ],
        "time_constraint": {
          "end": "14:00",
          "label": null,
          "mode": "exact",
          "start": "14:00"
        },
        "time_mode": "exact",
        "time_ref": "2 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "14:00",
        "label": null,
        "mode": "exact",
        "start": "14:00"
      },
      "time_mode": "exact",
      "time_ref": "2 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage",
      "time": "14:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '14:00', 'label': None, 'mode': 'exact', 'start': '14:00'}, 'time_mode': 'exact', 'time_ref': '2 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage', 'time': '14:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage', 'time': '14:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'massage', 'time': '14:00'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'time': '14:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_011_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "14:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: tomorrow ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_011_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "14:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_011_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'massage', 'time': '14:00'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'time': '14:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'time': '14:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=14:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_011_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '14:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=14:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_011_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_011_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "14:00",
        "date": "2026-01-14",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "time": "14:00",
      "date": "2026-01-14",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "massage",
      "time": "14:00",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_011_bbfbce9e - CLEARED (status=READY)

 Scenario 11 passed

============================================================
Scenario 12: service_to_time_to_date_haircut
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book haircut at 10am ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_012_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}, 'time_mode': 'exact', 'time_ref': '10 am'}
  context.time_constraint={'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}
  context.time_ref=10 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '10:00'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}, 'time_mode': 'exact', 'time_ref': '10 am'}
  context.time_constraint={'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}
  context.time_ref=10 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=10:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '10:00'}
  extraction_result.context.time_constraint={'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=10 am
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=10:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_012_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_012_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ],
      "time_constraint": {
        "end": "10:00",
        "label": null,
        "mode": "exact",
        "start": "10:00"
      },
      "time_mode": "exact",
      "time_ref": "10 am"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "10:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ],
        "time_constraint": {
          "end": "10:00",
          "label": null,
          "mode": "exact",
          "start": "10:00"
        },
        "time_mode": "exact",
        "time_ref": "10 am"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ],
      "time_constraint": {
        "end": "10:00",
        "label": null,
        "mode": "exact",
        "start": "10:00"
      },
      "time_mode": "exact",
      "time_ref": "10 am"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut",
      "time": "10:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '10:00', 'label': None, 'mode': 'exact', 'start': '10:00'}, 'time_mode': 'exact', 'time_ref': '10 am'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut', 'time': '10:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut', 'time': '10:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '10:00'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'time': '10:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_012_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "10:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: friday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_012_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "10:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_012_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-16'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '10:00'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'time': '10:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'time': '10:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=10:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_012_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '10:00', 'date': '2026-01-16', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=10:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_012_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_012_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "10:00",
        "date": "2026-01-16",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "time": "10:00",
      "date": "2026-01-16",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "time": "10:00",
      "date": "2026-01-16"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_012_bbfbce9e - CLEARED (status=READY)

 Scenario 12 passed

============================================================
Scenario 13: service_to_time_to_date_facial
============================================================
Domain: service, Turns: 2

--- Turn 1/2: schedule facial for 3pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_013_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'facial'}
  effective_collected_slots (after filter)={'service_id': 'facial'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial'}
  effective_response.context={'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}
  context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  context.time_ref=3 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '15:00'}
  extraction_result.context={'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}
  context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  context.time_ref=3 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=15:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '15:00'}
  extraction_result.context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=3 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=15:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_013_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_013_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ],
      "time_constraint": {
        "end": "15:00",
        "label": null,
        "mode": "exact",
        "start": "15:00"
      },
      "time_mode": "exact",
      "time_ref": "3 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "15:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "facial",
            "text": "facial"
          }
        ],
        "time_constraint": {
          "end": "15:00",
          "label": null,
          "mode": "exact",
          "start": "15:00"
        },
        "time_mode": "exact",
        "time_ref": "3 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ],
      "time_constraint": {
        "end": "15:00",
        "label": null,
        "mode": "exact",
        "start": "15:00"
      },
      "time_mode": "exact",
      "time_ref": "3 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "facial",
      "time": "15:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "facial"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'facial', 'time': '15:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'facial'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'facial', 'time': '15:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'facial', 'time': '15:00'}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'time': '15:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_013_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "15:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: next monday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_013_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "15:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_013_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-26'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'facial', 'time': '15:00'}
[DEBUG] Merge: session_slots={'service_id': 'facial', 'time': '15:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial', 'time': '15:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=15:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_013_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '15:00', 'date': '2026-01-26', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=15:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_013_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_013_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "15:00",
        "date": "2026-01-26",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "time": "15:00",
      "date": "2026-01-26",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "facial",
      "time": "15:00",
      "date": "2026-01-26"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_013_bbfbce9e - CLEARED (status=READY)

 Scenario 13 passed

============================================================
Scenario 14: service_to_time_to_date_morning
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book massage at 9am ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_014_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}, 'time_mode': 'exact', 'time_ref': '9 am'}
  context.time_constraint={'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}
  context.time_ref=9 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '09:00'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}, 'time_mode': 'exact', 'time_ref': '9 am'}
  context.time_constraint={'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}
  context.time_ref=9 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=09:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '09:00'}
  extraction_result.context.time_constraint={'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=9 am
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=09:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_014_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_014_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "09:00",
        "label": null,
        "mode": "exact",
        "start": "09:00"
      },
      "time_mode": "exact",
      "time_ref": "9 am"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "09:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ],
        "time_constraint": {
          "end": "09:00",
          "label": null,
          "mode": "exact",
          "start": "09:00"
        },
        "time_mode": "exact",
        "time_ref": "9 am"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "09:00",
        "label": null,
        "mode": "exact",
        "start": "09:00"
      },
      "time_mode": "exact",
      "time_ref": "9 am"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage",
      "time": "09:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '09:00', 'label': None, 'mode': 'exact', 'start': '09:00'}, 'time_mode': 'exact', 'time_ref': '9 am'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage', 'time': '09:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage', 'time': '09:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'massage', 'time': '09:00'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'time': '09:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_014_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "09:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: saturday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_014_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "09:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_014_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-17'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'massage', 'time': '09:00'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'time': '09:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'time': '09:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=09:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_014_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '09:00', 'date': '2026-01-17', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=09:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_014_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_014_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "09:00",
        "date": "2026-01-17",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "time": "09:00",
      "date": "2026-01-17",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "massage",
      "time": "09:00",
      "date": "2026-01-17"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_014_bbfbce9e - CLEARED (status=READY)

 Scenario 14 passed

============================================================
Scenario 15: service_to_time_to_date_evening
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book haircut at 6pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_015_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}, 'time_mode': 'exact', 'time_ref': '6 pm'}
  context.time_constraint={'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}
  context.time_ref=6 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '18:00'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}, 'time_mode': 'exact', 'time_ref': '6 pm'}
  context.time_constraint={'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}
  context.time_ref=6 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=18:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '18:00'}
  extraction_result.context.time_constraint={'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=6 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=18:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_015_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_015_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ],
      "time_constraint": {
        "end": "18:00",
        "label": null,
        "mode": "exact",
        "start": "18:00"
      },
      "time_mode": "exact",
      "time_ref": "6 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "18:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ],
        "time_constraint": {
          "end": "18:00",
          "label": null,
          "mode": "exact",
          "start": "18:00"
        },
        "time_mode": "exact",
        "time_ref": "6 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ],
      "time_constraint": {
        "end": "18:00",
        "label": null,
        "mode": "exact",
        "start": "18:00"
      },
      "time_mode": "exact",
      "time_ref": "6 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut",
      "time": "18:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}], 'time_constraint': {'end': '18:00', 'label': None, 'mode': 'exact', 'start': '18:00'}, 'time_mode': 'exact', 'time_ref': '6 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut', 'time': '18:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut', 'time': '18:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '18:00'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'time': '18:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_015_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "18:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: tuesday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_015_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "18:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_015_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-20'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '18:00'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'time': '18:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'time': '18:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=18:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_015_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '18:00', 'date': '2026-01-20', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=18:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_015_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_015_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "18:00",
        "date": "2026-01-20",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "time": "18:00",
      "date": "2026-01-20",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "time": "18:00",
      "date": "2026-01-20"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_015_bbfbce9e - CLEARED (status=READY)

 Scenario 15 passed

============================================================
Scenario 16: service_to_time_to_date_noon
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book manicure at noon ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_016_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'manicure'}
  effective_collected_slots (after filter)={'service_id': 'manicure'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'manicure'}
  effective_response.context={'services': [{'canonical': 'manicure', 'text': 'manicure'}], 'time_constraint': {'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}, 'time_mode': 'exact', 'time_ref': 'noon'}
  context.time_constraint={'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}
  context.time_ref=noon
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'time': '12:00'}
  extraction_result.context={'services': [{'canonical': 'manicure', 'text': 'manicure'}], 'time_constraint': {'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}, 'time_mode': 'exact', 'time_ref': 'noon'}
  context.time_constraint={'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}
  context.time_ref=noon
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=12:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'time': '12:00'}
  extraction_result.context.time_constraint={'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=noon
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=12:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_016_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_016_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "manicure",
          "text": "manicure"
        }
      ],
      "time_constraint": {
        "end": "12:00",
        "label": null,
        "mode": "exact",
        "start": "12:00"
      },
      "time_mode": "exact",
      "time_ref": "noon"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "manicure",
        "time": "12:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "manicure",
            "text": "manicure"
          }
        ],
        "time_constraint": {
          "end": "12:00",
          "label": null,
          "mode": "exact",
          "start": "12:00"
        },
        "time_mode": "exact",
        "time_ref": "noon"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "manicure",
          "text": "manicure"
        }
      ],
      "time_constraint": {
        "end": "12:00",
        "label": null,
        "mode": "exact",
        "start": "12:00"
      },
      "time_mode": "exact",
      "time_ref": "noon"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "manicure",
      "time": "12:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "manicure"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'manicure', 'text': 'manicure'}], 'time_constraint': {'end': '12:00', 'label': None, 'mode': 'exact', 'start': '12:00'}, 'time_mode': 'exact', 'time_ref': 'noon'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'manicure', 'time': '12:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'manicure'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'manicure', 'time': '12:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'manicure', 'time': '12:00'}
[DEBUG] Persisting to session: slots={'service_id': 'manicure', 'time': '12:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_016_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure",
    "time": "12:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: next week ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_016_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "manicure",
    "time": "12:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_016_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'manicure', 'time': '12:00'}
[DEBUG] Merge: session_slots={'service_id': 'manicure', 'time': '12:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'manicure', 'time': '12:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date_range'] = {'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date_range'], promoted_slots=['service_id', 'time', 'date_range']
[PROMOTION] ADDED date from date_range: 2026-01-19
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date_range'], promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  promoted_slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'manicure', 'time': '12:00', 'date': '2026-01-19'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  slots.time=12:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_016_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'manicure', 'time': '12:00', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  merged_session_slots.time=12:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date_range', 'date', 'has_datetime'], booking_services=[{'text': 'manicure'}]
[PLAN_STATUS] user_id=test_session_016_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_016_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "manicure",
        "time": "12:00",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        },
        "date": "2026-01-19",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date_range",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "manicure"
      }
    },
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "manicure",
      "time": "12:00",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      },
      "date": "2026-01-19",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "manicure"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "manicure",
      "time": "12:00",
      "date": "2026-01-19"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_016_bbfbce9e - CLEARED (status=READY)

 Scenario 16 passed

============================================================
Scenario 17: service_to_time_to_date_afternoon
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book pedicure at 4pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_017_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'pedicure'}
  effective_collected_slots (after filter)={'service_id': 'pedicure'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'pedicure'}
  effective_response.context={'services': [{'canonical': 'pedicure', 'text': 'pedicure'}], 'time_constraint': {'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}, 'time_mode': 'exact', 'time_ref': '4 pm'}
  context.time_constraint={'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}
  context.time_ref=4 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'time': '16:00'}
  extraction_result.context={'services': [{'canonical': 'pedicure', 'text': 'pedicure'}], 'time_constraint': {'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}, 'time_mode': 'exact', 'time_ref': '4 pm'}
  context.time_constraint={'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}
  context.time_ref=4 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=16:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'time': '16:00'}
  extraction_result.context.time_constraint={'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=4 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=16:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_017_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_017_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "pedicure",
          "text": "pedicure"
        }
      ],
      "time_constraint": {
        "end": "16:00",
        "label": null,
        "mode": "exact",
        "start": "16:00"
      },
      "time_mode": "exact",
      "time_ref": "4 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "pedicure",
        "time": "16:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "pedicure",
            "text": "pedicure"
          }
        ],
        "time_constraint": {
          "end": "16:00",
          "label": null,
          "mode": "exact",
          "start": "16:00"
        },
        "time_mode": "exact",
        "time_ref": "4 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "pedicure",
          "text": "pedicure"
        }
      ],
      "time_constraint": {
        "end": "16:00",
        "label": null,
        "mode": "exact",
        "start": "16:00"
      },
      "time_mode": "exact",
      "time_ref": "4 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "pedicure",
      "time": "16:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "pedicure"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'pedicure', 'text': 'pedicure'}], 'time_constraint': {'end': '16:00', 'label': None, 'mode': 'exact', 'start': '16:00'}, 'time_mode': 'exact', 'time_ref': '4 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'pedicure', 'time': '16:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'pedicure'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'pedicure', 'time': '16:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'pedicure', 'time': '16:00'}
[DEBUG] Persisting to session: slots={'service_id': 'pedicure', 'time': '16:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_017_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure",
    "time": "16:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: wednesday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_017_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "pedicure",
    "time": "16:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_017_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'pedicure', 'time': '16:00'}
[DEBUG] Merge: session_slots={'service_id': 'pedicure', 'time': '16:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'pedicure', 'time': '16:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=16:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_017_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'pedicure', 'time': '16:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=16:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'pedicure'}]
[PLAN_STATUS] user_id=test_session_017_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_017_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "pedicure",
        "time": "16:00",
        "date": "2026-01-14",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "pedicure"
      }
    },
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "pedicure",
      "time": "16:00",
      "date": "2026-01-14",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "pedicure"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "pedicure",
      "time": "16:00",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_017_bbfbce9e - CLEARED (status=READY)

 Scenario 17 passed

============================================================
Scenario 18: service_to_time_to_date_midday
============================================================
Domain: service, Turns: 2

--- Turn 1/2: schedule waxing at 1pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_018_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'waxing'}
  effective_collected_slots (after filter)={'service_id': 'waxing'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing'}
  effective_response.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}], 'time_constraint': {'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}, 'time_mode': 'exact', 'time_ref': '1 pm'}
  context.time_constraint={'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}
  context.time_ref=1 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'time': '13:00'}
  extraction_result.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}], 'time_constraint': {'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}, 'time_mode': 'exact', 'time_ref': '1 pm'}
  context.time_constraint={'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}
  context.time_ref=1 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=13:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'time': '13:00'}
  extraction_result.context.time_constraint={'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=1 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=13:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_018_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_018_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ],
      "time_constraint": {
        "end": "13:00",
        "label": null,
        "mode": "exact",
        "start": "13:00"
      },
      "time_mode": "exact",
      "time_ref": "1 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "waxing",
        "time": "13:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "waxing",
            "text": "waxing"
          }
        ],
        "time_constraint": {
          "end": "13:00",
          "label": null,
          "mode": "exact",
          "start": "13:00"
        },
        "time_mode": "exact",
        "time_ref": "1 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ],
      "time_constraint": {
        "end": "13:00",
        "label": null,
        "mode": "exact",
        "start": "13:00"
      },
      "time_mode": "exact",
      "time_ref": "1 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "waxing",
      "time": "13:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "waxing"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'waxing', 'text': 'waxing'}], 'time_constraint': {'end': '13:00', 'label': None, 'mode': 'exact', 'start': '13:00'}, 'time_mode': 'exact', 'time_ref': '1 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'waxing', 'time': '13:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'waxing'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'waxing', 'time': '13:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'waxing', 'time': '13:00'}
[DEBUG] Persisting to session: slots={'service_id': 'waxing', 'time': '13:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_018_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "time": "13:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: thursday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_018_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "time": "13:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_018_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-15'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'waxing', 'time': '13:00'}
[DEBUG] Merge: session_slots={'service_id': 'waxing', 'time': '13:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'waxing', 'time': '13:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15'}
[DEBUG] Promotion: promoted_slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=13:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_018_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'time': '13:00', 'date': '2026-01-15', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=13:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'waxing'}]
[PLAN_STATUS] user_id=test_session_018_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_018_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "waxing",
        "time": "13:00",
        "date": "2026-01-15",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "waxing"
      }
    },
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "waxing",
      "time": "13:00",
      "date": "2026-01-15",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "waxing",
      "time": "13:00",
      "date": "2026-01-15"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_018_bbfbce9e - CLEARED (status=READY)

 Scenario 18 passed

============================================================
Scenario 19: service_to_time_to_date_early
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book facial at 8am ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_019_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'facial'}
  effective_collected_slots (after filter)={'service_id': 'facial'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial'}
  effective_response.context={'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}, 'time_mode': 'exact', 'time_ref': '8 am'}
  context.time_constraint={'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}
  context.time_ref=8 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '08:00'}
  extraction_result.context={'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}, 'time_mode': 'exact', 'time_ref': '8 am'}
  context.time_constraint={'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}
  context.time_ref=8 am
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=08:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '08:00'}
  extraction_result.context.time_constraint={'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=8 am
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=08:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_019_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_019_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ],
      "time_constraint": {
        "end": "08:00",
        "label": null,
        "mode": "exact",
        "start": "08:00"
      },
      "time_mode": "exact",
      "time_ref": "8 am"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "08:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "facial",
            "text": "facial"
          }
        ],
        "time_constraint": {
          "end": "08:00",
          "label": null,
          "mode": "exact",
          "start": "08:00"
        },
        "time_mode": "exact",
        "time_ref": "8 am"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ],
      "time_constraint": {
        "end": "08:00",
        "label": null,
        "mode": "exact",
        "start": "08:00"
      },
      "time_mode": "exact",
      "time_ref": "8 am"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "facial",
      "time": "08:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "facial"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'facial', 'text': 'facial'}], 'time_constraint': {'end': '08:00', 'label': None, 'mode': 'exact', 'start': '08:00'}, 'time_mode': 'exact', 'time_ref': '8 am'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'facial', 'time': '08:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'facial'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'facial', 'time': '08:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'facial', 'time': '08:00'}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'time': '08:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_019_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "08:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: next friday ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_019_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "08:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_019_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-23'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'facial', 'time': '08:00'}
[DEBUG] Merge: session_slots={'service_id': 'facial', 'time': '08:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial', 'time': '08:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=08:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_019_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '08:00', 'date': '2026-01-23', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=08:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_019_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_019_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "08:00",
        "date": "2026-01-23",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "time": "08:00",
      "date": "2026-01-23",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "facial",
      "time": "08:00",
      "date": "2026-01-23"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_019_bbfbce9e - CLEARED (status=READY)

 Scenario 19 passed

============================================================
Scenario 20: service_to_time_to_date_late
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book massage at 7pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_020_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}, 'time_mode': 'exact', 'time_ref': '7 pm'}
  context.time_constraint={'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}
  context.time_ref=7 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '19:00'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}, 'time_mode': 'exact', 'time_ref': '7 pm'}
  context.time_constraint={'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}
  context.time_ref=7 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=19:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '19:00'}
  extraction_result.context.time_constraint={'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=7 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=19:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_020_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_020_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "19:00",
        "label": null,
        "mode": "exact",
        "start": "19:00"
      },
      "time_mode": "exact",
      "time_ref": "7 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "19:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ],
        "time_constraint": {
          "end": "19:00",
          "label": null,
          "mode": "exact",
          "start": "19:00"
        },
        "time_mode": "exact",
        "time_ref": "7 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "19:00",
        "label": null,
        "mode": "exact",
        "start": "19:00"
      },
      "time_mode": "exact",
      "time_ref": "7 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage",
      "time": "19:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '19:00', 'label': None, 'mode': 'exact', 'start': '19:00'}, 'time_mode': 'exact', 'time_ref': '7 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage', 'time': '19:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage', 'time': '19:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'massage', 'time': '19:00'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'time': '19:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_020_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "19:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: this weekend ---
Expected: {
  "status": "READY",
  "slots": {
    "has_datetime": true
  }
}

[SESSION BEFORE TURN 2] user_id=test_session_020_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "19:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_020_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'massage', 'time': '19:00'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'time': '19:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'time': '19:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date_range'] = {'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date_range'], promoted_slots=['service_id', 'time', 'date_range']
[PROMOTION] ADDED date from date_range: 2026-01-17
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date_range'], promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  promoted_slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'massage', 'time': '19:00', 'date': '2026-01-17'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date_range', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  slots.time=19:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date_range', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_020_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '19:00', 'date_range': {'end': '2026-01-18', 'start': '2026-01-17'}, 'date': '2026-01-17', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date_range', 'date', 'has_datetime']
  merged_session_slots.time=19:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date_range', 'date', 'has_datetime'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_020_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_020_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "19:00",
        "date_range": {
          "end": "2026-01-18",
          "start": "2026-01-17"
        },
        "date": "2026-01-17",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date_range",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "time": "19:00",
      "date_range": {
        "end": "2026-01-18",
        "start": "2026-01-17"
      },
      "date": "2026-01-17",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "massage",
      "time": "19:00",
      "date": "2026-01-17"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_020_bbfbce9e - CLEARED (status=READY)

 Scenario 20 passed

============================================================
Scenario 21: reservation_checkin_to_checkout
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: reserve a room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_021_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'room'}
  effective_collected_slots (after filter)={'service_id': 'room'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "room"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "room"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "room"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "room"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'room'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'room'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'room'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'room'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'room'}
[DEBUG] Persisting to session: slots={'service_id': 'room'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_021_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from october 5th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_021_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_021_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-10-05'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'room'}
[DEBUG] Merge: session_slots={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'date': '2026-10-05'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'room', 'date': '2026-10-05'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-10-05 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-10-05'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-10-05'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-10-05'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-10-05'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-10-05'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_021_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'room', 'start_date': '2026-10-05'} effective_response_slots={'service_id': 'room', 'start_date': '2026-10-05'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-10-05"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "start_date": "2026-10-05"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-10-05"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'room', 'start_date': '2026-10-05'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-10-05'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-10-05'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_021_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-10-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: to october 9th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_021_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-10-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_021_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-10-09'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Merge: session_slots={'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room', 'start_date': '2026-10-05'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'start_date': '2026-10-05', 'date': '2026-10-09'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'room', 'start_date': '2026-10-05', 'date': '2026-10-09'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-10-09, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-10-09 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-10-09, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_021_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_021_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_021_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'} effective_response_slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-10-05",
        "end_date": "2026-10-09"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "start_date": "2026-10-05",
      "end_date": "2026-10-09"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-10-05",
      "end_date": "2026-10-09"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-10-05', 'end_date': '2026-10-09'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_021_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-10-05",
    "end_date": "2026-10-09"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 22: reservation_suite_checkin_checkout
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: book suite ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_022_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'suite'}
  effective_collected_slots (after filter)={'service_id': 'suite'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "suite"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "suite"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "suite"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "suite"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'suite'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'suite'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'suite'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'suite'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'suite'}
[DEBUG] Persisting to session: slots={'service_id': 'suite'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_022_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from nov 1st ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_022_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_022_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-11-01'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'suite'}
[DEBUG] Merge: session_slots={'service_id': 'suite'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'suite'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'suite', 'date': '2026-11-01'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'suite', 'date': '2026-11-01'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-11-01 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Promotion: promoted_slots={'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'suite', 'start_date': '2026-11-01'}
  effective_collected_slots (after filter)={'service_id': 'suite', 'start_date': '2026-11-01'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite', 'start_date': '2026-11-01'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'start_date': '2026-11-01'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'start_date': '2026-11-01'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_022_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'suite', 'start_date': '2026-11-01'} effective_response_slots={'service_id': 'suite', 'start_date': '2026-11-01'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "suite",
        "start_date": "2026-11-01"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "suite"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "suite",
      "start_date": "2026-11-01"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "suite",
      "start_date": "2026-11-01"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'suite', 'start_date': '2026-11-01'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'suite', 'start_date': '2026-11-01'}}
  slots from merged_luma_response={'service_id': 'suite', 'start_date': '2026-11-01'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Persisting to session: slots={'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_022_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite",
    "start_date": "2026-11-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: to nov 5th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_022_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite",
    "start_date": "2026-11-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_022_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-11-05'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Merge: session_slots={'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'suite', 'start_date': '2026-11-01'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'suite', 'start_date': '2026-11-01', 'date': '2026-11-05'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'suite', 'start_date': '2026-11-01', 'date': '2026-11-05'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-11-05, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-11-05 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-11-05, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
[DEBUG] Promotion: promoted_slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  effective_collected_slots (after filter)={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_022_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_022_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_022_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'} effective_response_slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "suite",
        "start_date": "2026-11-01",
        "end_date": "2026-11-05"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "suite"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "suite",
      "start_date": "2026-11-01",
      "end_date": "2026-11-05"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "suite",
      "start_date": "2026-11-01",
      "end_date": "2026-11-05"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}}
  slots from merged_luma_response={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
[DEBUG] Persisting to session: slots={'service_id': 'suite', 'start_date': '2026-11-01', 'end_date': '2026-11-05'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_022_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite",
    "start_date": "2026-11-01",
    "end_date": "2026-11-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 23: reservation_deluxe_checkin_checkout
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: reserve deluxe room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_023_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'deluxe'}
  effective_collected_slots (after filter)={'service_id': 'deluxe'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'deluxe'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'deluxe'}, {'canonical': 'hospitality.room', 'text': 'deluxe'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'deluxe'}, {'canonical': 'hospitality.room', 'text': 'deluxe'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "deluxe"
        },
        {
          "canonical": "hospitality.room",
          "text": "deluxe"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "deluxe"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "deluxe"
          },
          {
            "canonical": "hospitality.room",
            "text": "deluxe"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "deluxe"
        },
        {
          "canonical": "hospitality.room",
          "text": "deluxe"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "deluxe"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "deluxe"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'deluxe'}, {'canonical': 'hospitality.room', 'text': 'deluxe'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'deluxe'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'deluxe'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'deluxe'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'deluxe'}
[DEBUG] Persisting to session: slots={'service_id': 'deluxe'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_023_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from dec 10th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_023_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_023_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-12-10'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'deluxe'}
[DEBUG] Merge: session_slots={'service_id': 'deluxe'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'deluxe'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'deluxe', 'date': '2026-12-10'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'deluxe', 'date': '2026-12-10'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-12-10 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Promotion: promoted_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  effective_collected_slots (after filter)={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_023_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'} effective_response_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "deluxe",
        "start_date": "2026-12-10"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "deluxe"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "deluxe",
      "start_date": "2026-12-10"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "deluxe",
      "start_date": "2026-12-10"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'deluxe', 'start_date': '2026-12-10'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'deluxe', 'start_date': '2026-12-10'}}
  slots from merged_luma_response={'service_id': 'deluxe', 'start_date': '2026-12-10'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Persisting to session: slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_023_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe",
    "start_date": "2026-12-10"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: through dec 15th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_023_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe",
    "start_date": "2026-12-10"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_023_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-12-15'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Merge: session_slots={'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'deluxe', 'start_date': '2026-12-10'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'deluxe', 'start_date': '2026-12-10', 'date': '2026-12-15'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'deluxe', 'start_date': '2026-12-10', 'date': '2026-12-15'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-12-15, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-12-15 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-12-15, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
[DEBUG] Promotion: promoted_slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  effective_collected_slots (after filter)={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_023_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_023_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_023_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'} effective_response_slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "deluxe",
        "start_date": "2026-12-10",
        "end_date": "2026-12-15"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "deluxe"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "deluxe",
      "start_date": "2026-12-10",
      "end_date": "2026-12-15"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "deluxe",
      "start_date": "2026-12-10",
      "end_date": "2026-12-15"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}}
  slots from merged_luma_response={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
[DEBUG] Persisting to session: slots={'service_id': 'deluxe', 'start_date': '2026-12-10', 'end_date': '2026-12-15'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_023_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe",
    "start_date": "2026-12-10",
    "end_date": "2026-12-15"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 24: reservation_standard_checkin_checkout
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: book standard room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_024_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'standard'}
  effective_collected_slots (after filter)={'service_id': 'standard'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'standard'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'standard'}, {'canonical': 'hospitality.room', 'text': 'standard'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'standard'}, {'canonical': 'hospitality.room', 'text': 'standard'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "standard"
        },
        {
          "canonical": "hospitality.room",
          "text": "standard"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "standard"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "standard"
          },
          {
            "canonical": "hospitality.room",
            "text": "standard"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "standard"
        },
        {
          "canonical": "hospitality.room",
          "text": "standard"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "standard"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "standard"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'standard'}, {'canonical': 'hospitality.room', 'text': 'standard'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'standard'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'standard'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'standard'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'standard'}
[DEBUG] Persisting to session: slots={'service_id': 'standard'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_024_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from jan 5th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_024_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_024_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2027-01-05'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'standard'}
[DEBUG] Merge: session_slots={'service_id': 'standard'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'standard'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'standard', 'date': '2027-01-05'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'standard', 'date': '2027-01-05'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2027-01-05 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Promotion: promoted_slots={'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'standard', 'start_date': '2027-01-05'}
  effective_collected_slots (after filter)={'service_id': 'standard', 'start_date': '2027-01-05'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'standard', 'start_date': '2027-01-05'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'start_date': '2027-01-05'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'start_date': '2027-01-05'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_024_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'standard', 'start_date': '2027-01-05'} effective_response_slots={'service_id': 'standard', 'start_date': '2027-01-05'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "standard",
        "start_date": "2027-01-05"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "standard"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "standard",
      "start_date": "2027-01-05"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "standard",
      "start_date": "2027-01-05"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'standard', 'start_date': '2027-01-05'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'standard', 'start_date': '2027-01-05'}}
  slots from merged_luma_response={'service_id': 'standard', 'start_date': '2027-01-05'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Persisting to session: slots={'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_024_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard",
    "start_date": "2027-01-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: until jan 8th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_024_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard",
    "start_date": "2027-01-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_024_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2027-01-08'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Merge: session_slots={'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'standard', 'start_date': '2027-01-05'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'standard', 'start_date': '2027-01-05', 'date': '2027-01-08'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'standard', 'start_date': '2027-01-05', 'date': '2027-01-08'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2027-01-08, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2027-01-08 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2027-01-08, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
[DEBUG] Promotion: promoted_slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  effective_collected_slots (after filter)={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_024_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_024_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_024_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'} effective_response_slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "standard",
        "start_date": "2027-01-05",
        "end_date": "2027-01-08"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "standard"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "standard",
      "start_date": "2027-01-05",
      "end_date": "2027-01-08"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "standard",
      "start_date": "2027-01-05",
      "end_date": "2027-01-08"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}}
  slots from merged_luma_response={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
[DEBUG] Persisting to session: slots={'service_id': 'standard', 'start_date': '2027-01-05', 'end_date': '2027-01-08'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_024_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard",
    "start_date": "2027-01-05",
    "end_date": "2027-01-08"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 25: reservation_penthouse_checkin_checkout
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: reserve penthouse ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_025_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'penthouse'}
  effective_collected_slots (after filter)={'service_id': 'penthouse'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'penthouse'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'penthouse'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'penthouse'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "penthouse"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "penthouse"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "penthouse"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "penthouse"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "penthouse"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "penthouse"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'penthouse'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'penthouse'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'penthouse'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'penthouse'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'penthouse'}
[DEBUG] Persisting to session: slots={'service_id': 'penthouse'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_025_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "penthouse"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from feb 1st ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_025_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "penthouse"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_025_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-02-01'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'penthouse'}
[DEBUG] Merge: session_slots={'service_id': 'penthouse'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'penthouse'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'penthouse', 'date': '2026-02-01'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'penthouse', 'date': '2026-02-01'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-02-01 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Promotion: promoted_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  effective_collected_slots (after filter)={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_025_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'} effective_response_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "penthouse",
        "start_date": "2026-02-01"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "penthouse"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "penthouse",
      "start_date": "2026-02-01"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "penthouse",
      "start_date": "2026-02-01"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'penthouse', 'start_date': '2026-02-01'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'penthouse', 'start_date': '2026-02-01'}}
  slots from merged_luma_response={'service_id': 'penthouse', 'start_date': '2026-02-01'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Persisting to session: slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_025_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "penthouse",
    "start_date": "2026-02-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: to feb 5th ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_025_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "penthouse",
    "start_date": "2026-02-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_025_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-02-05'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Merge: session_slots={'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'penthouse', 'start_date': '2026-02-01'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'penthouse', 'start_date': '2026-02-01', 'date': '2026-02-05'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'penthouse', 'start_date': '2026-02-01', 'date': '2026-02-05'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-02-05, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-02-05 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-02-05, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
[DEBUG] Promotion: promoted_slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  effective_collected_slots (after filter)={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_025_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_025_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_025_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'} effective_response_slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "penthouse",
        "start_date": "2026-02-01",
        "end_date": "2026-02-05"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "penthouse"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "penthouse",
      "start_date": "2026-02-01",
      "end_date": "2026-02-05"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "penthouse",
      "start_date": "2026-02-01",
      "end_date": "2026-02-05"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}}
  slots from merged_luma_response={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
[DEBUG] Persisting to session: slots={'service_id': 'penthouse', 'start_date': '2026-02-01', 'end_date': '2026-02-05'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_025_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "penthouse",
    "start_date": "2026-02-01",
    "end_date": "2026-02-05"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 26: reservation_range_followup
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: book room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_026_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'room'}
  effective_collected_slots (after filter)={'service_id': 'room'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_026_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_026_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "room"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "room"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "room"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "room"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'room'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'room'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'room'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'room'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'room'}
[DEBUG] Persisting to session: slots={'service_id': 'room'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_026_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: march 10 to 15 ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 2] user_id=test_session_026_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_026_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'room'}
[DEBUG] Merge: session_slots={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=False
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED start_date from date_range: 2026-03-10
[PROMOTION] ADDED end_date from date_range: 2026-03-15
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}, 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'date_range', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['date_range', 'end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
  promoted_slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}, 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range', 'start_date', 'end_date'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}, 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}, 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_026_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'date_range': {'end': '2026-03-15', 'start': '2026-03-10'}, 'start_date': '2026-03-10', 'end_date': '2026-03-15'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_026_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_026_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "room",
        "date_range": {
          "end": "2026-03-15",
          "start": "2026-03-10"
        },
        "start_date": "2026-03-10",
        "end_date": "2026-03-15"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "booking": {},
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "date_range": {
        "end": "2026-03-15",
        "start": "2026-03-10"
      },
      "start_date": "2026-03-10",
      "end_date": "2026-03-15"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-03-10",
      "end_date": "2026-03-15"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_026_bbfbce9e - CLEARED (status=READY)

 Scenario 26 passed

============================================================
Scenario 27: reservation_suite_range
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: book suite ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_027_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'suite'}
  effective_collected_slots (after filter)={'service_id': 'suite'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_027_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_027_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "suite"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "suite"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "suite"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "suite"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'suite'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'suite'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'suite'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'suite'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'suite'}
[DEBUG] Persisting to session: slots={'service_id': 'suite'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_027_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: april 1st to 3rd ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 2] user_id=test_session_027_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_027_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'suite'}
[DEBUG] Merge: session_slots={'service_id': 'suite'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'suite'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=False
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED start_date from date_range: 2026-04-01
[PROMOTION] ADDED end_date from date_range: 2026-04-03
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}, 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'date_range', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['date_range', 'end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
  promoted_slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}, 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
  effective_collected_slots (after filter)={'service_id': 'suite', 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range', 'start_date', 'end_date'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}, 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}, 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_027_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite', 'date_range': {'end': '2026-04-03', 'start': '2026-04-01'}, 'start_date': '2026-04-01', 'end_date': '2026-04-03'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_027_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_027_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "suite",
        "date_range": {
          "end": "2026-04-03",
          "start": "2026-04-01"
        },
        "start_date": "2026-04-01",
        "end_date": "2026-04-03"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "suite"
      }
    },
    "booking": {},
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "suite",
      "date_range": {
        "end": "2026-04-03",
        "start": "2026-04-01"
      },
      "start_date": "2026-04-01",
      "end_date": "2026-04-03"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "suite",
      "start_date": "2026-04-01",
      "end_date": "2026-04-03"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_027_bbfbce9e - CLEARED (status=READY)

 Scenario 27 passed

============================================================
Scenario 28: reservation_deluxe_range
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: reserve deluxe ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_028_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'deluxe'}
  effective_collected_slots (after filter)={'service_id': 'deluxe'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'deluxe'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'deluxe'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'deluxe'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_028_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_028_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "deluxe"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "deluxe"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "deluxe"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "deluxe"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "deluxe"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "deluxe"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'deluxe'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'deluxe'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'deluxe'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'deluxe'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'deluxe'}
[DEBUG] Persisting to session: slots={'service_id': 'deluxe'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_028_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: may 20 to 25 ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 2] user_id=test_session_028_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "deluxe"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_028_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'deluxe'}
[DEBUG] Merge: session_slots={'service_id': 'deluxe'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'deluxe'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=False
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED start_date from date_range: 2026-05-20
[PROMOTION] ADDED end_date from date_range: 2026-05-25
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}, 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'date_range', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['date_range', 'end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
  promoted_slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}, 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
  effective_collected_slots (after filter)={'service_id': 'deluxe', 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range', 'start_date', 'end_date'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}, 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}, 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_028_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'deluxe', 'date_range': {'end': '2026-05-25', 'start': '2026-05-20'}, 'start_date': '2026-05-20', 'end_date': '2026-05-25'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_028_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_028_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "deluxe",
        "date_range": {
          "end": "2026-05-25",
          "start": "2026-05-20"
        },
        "start_date": "2026-05-20",
        "end_date": "2026-05-25"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "deluxe"
      }
    },
    "booking": {},
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "deluxe",
      "date_range": {
        "end": "2026-05-25",
        "start": "2026-05-20"
      },
      "start_date": "2026-05-20",
      "end_date": "2026-05-25"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "deluxe",
      "start_date": "2026-05-20",
      "end_date": "2026-05-25"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_028_bbfbce9e - CLEARED (status=READY)

 Scenario 28 passed

============================================================
Scenario 29: reservation_standard_range
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: book standard ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_029_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'standard'}
  effective_collected_slots (after filter)={'service_id': 'standard'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'standard'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'standard'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'standard'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_029_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_029_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "standard"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "standard"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "standard"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "standard"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "standard"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "standard"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'standard'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'standard'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'standard'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'standard'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'standard'}
[DEBUG] Persisting to session: slots={'service_id': 'standard'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_029_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: june 1 to 5 ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 2] user_id=test_session_029_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "standard"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_029_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'standard'}
[DEBUG] Merge: session_slots={'service_id': 'standard'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'standard'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=False
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED start_date from date_range: 2026-06-01
[PROMOTION] ADDED end_date from date_range: 2026-06-05
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}, 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'date_range', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['date_range', 'end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'date_range', 'start_date', 'end_date']
  promoted_slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}, 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
  effective_collected_slots (after filter)={'service_id': 'standard', 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'date_range', 'start_date', 'end_date'], promoted_slots=['service_id', 'date_range', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}, 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}, 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_029_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'standard', 'date_range': {'end': '2026-06-05', 'start': '2026-06-01'}, 'start_date': '2026-06-01', 'end_date': '2026-06-05'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_029_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_029_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "standard",
        "date_range": {
          "end": "2026-06-05",
          "start": "2026-06-01"
        },
        "start_date": "2026-06-01",
        "end_date": "2026-06-05"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "standard"
      }
    },
    "booking": {},
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "standard",
      "date_range": {
        "end": "2026-06-05",
        "start": "2026-06-01"
      },
      "start_date": "2026-06-01",
      "end_date": "2026-06-05"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "standard",
      "start_date": "2026-06-01",
      "end_date": "2026-06-05"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 2] user_id=test_session_029_bbfbce9e - CLEARED (status=READY)

 Scenario 29 passed

============================================================
Scenario 30: reservation_multi_turn_range
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: reserve room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_030_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'room'}
  effective_collected_slots (after filter)={'service_id': 'room'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "room"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "room"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "room"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "room"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'room'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'room'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'room'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'room'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'room'}
[DEBUG] Persisting to session: slots={'service_id': 'room'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_030_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from july 1 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_030_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_030_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-07-01'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'room'}
[DEBUG] Merge: session_slots={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'date': '2026-07-01'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'room', 'date': '2026-07-01'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-07-01 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-07-01'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-07-01'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-07-01'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-07-01'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-07-01'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_030_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'room', 'start_date': '2026-07-01'} effective_response_slots={'service_id': 'room', 'start_date': '2026-07-01'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-07-01"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "start_date": "2026-07-01"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-07-01"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'room', 'start_date': '2026-07-01'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-07-01'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-07-01'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_030_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-07-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/3: to july 7 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_030_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-07-01"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_030_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-07-07'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Merge: session_slots={'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room', 'start_date': '2026-07-01'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'start_date': '2026-07-01', 'date': '2026-07-07'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date', 'date'] = {'service_id': 'room', 'start_date': '2026-07-01', 'date': '2026-07-07'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-07-07, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-07-07 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-07-07, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_030_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_030_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_030_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'} effective_response_slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-07-01",
        "end_date": "2026-07-07"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "start_date": "2026-07-01",
      "end_date": "2026-07-07"
    },
    "status": "ready",
    "success": true,
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-07-01",
      "end_date": "2026-07-07"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}, 'status': 'ready', 'success': True, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-07-01', 'end_date': '2026-07-07'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_030_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-07-01",
    "end_date": "2026-07-07"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 31: modify_booking_time_only
============================================================
Domain: service, Turns: 2

--- Turn 1/2: change my booking to 3pm ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_031_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_031_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_031_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_031_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: booking abc123 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_031_bbfbce9e
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_031_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: [] = {}
[DEBUG] Merge: session_slots={}
[DEBUG] Merge: merged_slots (after copy)={}
[DEBUG] Merge: merged_slots (after luma merge)={}
[DEBUG] Merge: merged_slots.keys()=[]
[SLOT_DURABILITY] merged_slots after merge: [] = {}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=MODIFY_BOOKING, session_state=True, merged_slots.keys()=[]
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=[], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=MODIFY_BOOKING, session_intent=MODIFY_BOOKING, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: []
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[INFORMATIONAL_TURN] Preserved missing_slots: ['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_031_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['booking_id', 'date'], slots_keys=[], booking_services=None
[PLAN_STATUS] user_id=test_session_031_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_031_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_031_bbfbce9e intent=MODIFY_BOOKING missing_slots_from_facts=['booking_id', 'date'] missing_slots_from_response=['booking_id', 'date'] final_missing_slots=['booking_id', 'date']
  facts_slots={} effective_response_slots={}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [
        "booking_id",
        "date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "booking_id",
          "date"
        ],
        "filtered_missing_slots": [
          "booking_id",
          "date"
        ],
        "slots_keys": [],
        "booking_has_services": false,
        "service_id_in_slots": false,
        "service_id_value": null
      }
    },
    "intent_name": "MODIFY_BOOKING",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ],
    "_effective_collected_slots": {}
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {}, 'missing_slots': ['booking_id', 'date'], '_effective_collected_slots': {}}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_031_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 32: modify_booking_date_only
============================================================
Domain: service, Turns: 2

--- Turn 1/2: change booking to friday ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_032_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_032_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_032_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_032_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_032_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_032_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_032_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 33: modify_booking_date_range
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: change my reservation ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_033_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_033_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_033_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_033_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_033_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_033_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_033_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 34: modify_booking_time_followup
============================================================
Domain: service, Turns: 2

--- Turn 1/2: change booking ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_034_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_034_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_034_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_034_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_034_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_034_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_034_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 35: modify_booking_date_followup
============================================================
Domain: service, Turns: 2

--- Turn 1/2: modify booking ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_035_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_035_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_035_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_035_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_035_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_035_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_035_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 36: modify_reservation_range
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: change reservation ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_036_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_036_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_036_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_036_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_036_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_036_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_036_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 37: modify_booking_with_id
============================================================
Domain: service, Turns: 2

--- Turn 1/2: change booking abc123 ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_037_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_037_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_037_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_037_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_037_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_037_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_037_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 38: modify_reservation_with_id
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: change reservation xyz789 ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_038_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_038_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_038_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_038_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_038_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_038_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_038_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 39: modify_booking_multiple_turns
============================================================
Domain: service, Turns: 3

--- Turn 1/3: change booking ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_039_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_039_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_039_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_039_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_039_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_039_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_039_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 40: modify_reservation_multiple_turns
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: change reservation ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_040_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_040_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_040_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_040_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_040_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_040_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_040_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 41: ambiguous_tomorrow_followup
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_041_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_041_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: tomorrow ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_041_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_041_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_041_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14'} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_041_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: evening ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_041_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_041_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '17:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=17:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_041_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=17:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_041_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_041_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14",
        "time": "17:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "17:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "17:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '17:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_041_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14",
    "time": "17:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 42: ambiguous_next_friday
============================================================
Domain: service, Turns: 3

--- Turn 1/3: schedule massage ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_042_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Persisting to session: slots={'service_id': 'massage'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_042_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next friday ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_042_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_042_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-23'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Merge: session_slots={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-23'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'massage', 'date': '2026-01-23'}
  effective_collected_slots (after filter)={'service_id': 'massage', 'date': '2026-01-23'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'date': '2026-01-23'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-23'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-23'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_042_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'massage', 'date': '2026-01-23'} effective_response_slots={'service_id': 'massage', 'date': '2026-01-23'}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage",
        "date": "2026-01-23"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "date": "2026-01-23"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "massage",
      "date": "2026-01-23"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'massage', 'date': '2026-01-23'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'massage'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'massage', 'date': '2026-01-23'}}
  slots from merged_luma_response={'service_id': 'massage', 'date': '2026-01-23'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_042_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-23"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: 2pm ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_042_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-23"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_042_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '14:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'date': '2026-01-23'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=14:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_042_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=14:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_042_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_042_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True} effective_response_slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage",
        "date": "2026-01-23",
        "time": "14:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "date": "2026-01-23",
      "time": "14:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "massage",
      "date": "2026-01-23",
      "time": "14:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'massage'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00'}}
  slots from merged_luma_response={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'time', 'has_datetime'] = {'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'date': '2026-01-23', 'time': '14:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_042_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "date": "2026-01-23",
    "time": "14:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 43: ambiguous_evening_followup
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book facial ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_043_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'facial'}
  effective_collected_slots (after filter)={'service_id': 'facial'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial'}
  effective_response.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "facial",
            "text": "facial"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "facial"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "facial"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'facial', 'text': 'facial'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'facial'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'facial'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'facial'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'facial'}
[DEBUG] Persisting to session: slots={'service_id': 'facial'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_043_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: evening ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_043_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_043_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '17:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'facial'}
[DEBUG] Merge: session_slots={'service_id': 'facial'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time'] = {'service_id': 'facial', 'time': '17:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time'], promoted_slots=['service_id', 'time']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time'], promoted_slots=['service_id', 'time']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time']
  promoted_slots={'service_id': 'facial', 'time': '17:00'}
  effective_collected_slots (after filter)={'service_id': 'facial', 'time': '17:00'}
  effective_collected_slots.keys()=['service_id', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time'], promoted_slots=['service_id', 'time'], effective_collected=['service_id', 'time'], missing_slots=['date']

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'time': '17:00'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '17:00'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=17:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date'], filtered=['date'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '17:00'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=17:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=date, missing_slots=['date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=date, missing_slots=['date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['date'], slots_keys=['service_id', 'time'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['date']
[PLAN_STATUS_CHECK] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_043_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['date'] missing_slots_from_response=['date'] final_missing_slots=['date']
  facts_slots={'service_id': 'facial', 'time': '17:00'} effective_response_slots={'service_id': 'facial', 'time': '17:00'}
  effective_response_booking_services=[{'text': 'facial'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "17:00"
      },
      "missing_slots": [
        "date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "date"
        ],
        "filtered_missing_slots": [
          "date"
        ],
        "slots_keys": [
          "service_id",
          "time"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "time": "17:00"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "date"
    ],
    "_effective_collected_slots": {
      "service_id": "facial",
      "time": "17:00"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'facial', 'time': '17:00'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'facial'}]}, 'context': {}, 'missing_slots': ['date'], '_effective_collected_slots': {'service_id': 'facial', 'time': '17:00'}}
  slots from merged_luma_response={'service_id': 'facial', 'time': '17:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'facial', 'time': '17:00'}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_043_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "17:00"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

--- Turn 3/3: tomorrow ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_043_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "17:00"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

[RAW_LUMA_DEBUG] user_id=test_session_043_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'facial', 'time': '17:00'}
[DEBUG] Merge: session_slots={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'facial', 'time': '17:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=date, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=date, awaiting_slot_in_session=date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=date, awaiting_slot_in_session=date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=date, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=date, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=17:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_043_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=17:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'facial'}]
[PLAN_STATUS] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_043_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_043_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True} effective_response_slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'facial'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "facial",
        "time": "17:00",
        "date": "2026-01-14",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "facial"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "facial",
      "time": "17:00",
      "date": "2026-01-14",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "facial"
        }
      ]
    },
    "awaiting_slot": "date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "facial",
      "time": "17:00",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'facial'}]}, 'awaiting_slot': 'date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
  slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time', 'date', 'has_datetime'] = {'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'facial', 'time': '17:00', 'date': '2026-01-14', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time', 'date', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time', 'date', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_043_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial",
    "time": "17:00",
    "date": "2026-01-14",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

============================================================
Scenario 44: ambiguous_morning_followup
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_044_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_044_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: morning ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_044_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_044_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '08:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '08:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time'], promoted_slots=['service_id', 'time']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time'], promoted_slots=['service_id', 'time']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'time']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time']
  promoted_slots={'service_id': 'haircut', 'time': '08:00'}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'time': '08:00'}
  effective_collected_slots.keys()=['service_id', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time'], promoted_slots=['service_id', 'time'], effective_collected=['service_id', 'time'], missing_slots=['date']

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'time': '08:00'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '08:00'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=08:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date'], filtered=['date'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '08:00'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=08:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=date, missing_slots=['date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=date, missing_slots=['date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['date'], slots_keys=['service_id', 'time'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['date']
[PLAN_STATUS_CHECK] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_044_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['date'] missing_slots_from_response=['date'] final_missing_slots=['date']
  facts_slots={'service_id': 'haircut', 'time': '08:00'} effective_response_slots={'service_id': 'haircut', 'time': '08:00'}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "08:00"
      },
      "missing_slots": [
        "date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "date"
        ],
        "filtered_missing_slots": [
          "date"
        ],
        "slots_keys": [
          "service_id",
          "time"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "time": "08:00"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "date"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "time": "08:00"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'time': '08:00'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'context': {}, 'missing_slots': ['date'], '_effective_collected_slots': {'service_id': 'haircut', 'time': '08:00'}}
  slots from merged_luma_response={'service_id': 'haircut', 'time': '08:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_044_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "08:00"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

--- Turn 3/3: friday ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_044_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "08:00"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

[RAW_LUMA_DEBUG] user_id=test_session_044_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-16'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'time': '08:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time', 'date'] = {'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=date, merged_slots.keys()=['service_id', 'time', 'date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date'], promoted_slots=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'time', 'date', 'has_datetime'], awaiting_slot_in_merged=date, awaiting_slot_in_session=date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=date, awaiting_slot_in_session=date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=date, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=date, merged['slots'].keys()=['service_id', 'time', 'date', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'time', 'date', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16'}
  effective_collected_slots.keys()=['service_id', 'time', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'time', 'date', 'has_datetime'], promoted_slots=['service_id', 'time', 'date', 'has_datetime'], effective_collected=['service_id', 'time', 'date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time', 'date', 'has_datetime']
  slots.time=08:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'time', 'date', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_044_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time', 'date', 'has_datetime']
  merged_session_slots.time=08:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'time', 'date', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_044_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_044_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True} effective_response_slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "time": "08:00",
        "date": "2026-01-16",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "time",
          "date",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "time": "08:00",
      "date": "2026-01-16",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "awaiting_slot": "date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "time": "08:00",
      "date": "2026-01-16"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'awaiting_slot': 'date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16'}}
  slots from merged_luma_response={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
  slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time', 'date', 'has_datetime'] = {'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'time': '08:00', 'date': '2026-01-16', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time', 'date', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time', 'date', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time', 'date', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_044_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "time": "08:00",
    "date": "2026-01-16",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

============================================================
Scenario 45: unknown_to_booking_via_followup
============================================================
Domain: service, Turns: 3

--- Turn 1/3: hello ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 1] user_id=test_session_045_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=UNKNOWN, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=UNKNOWN, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=UNKNOWN
  required_slots_set=set()
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=UNKNOWN, collected_slots=[], planning_required_slots=[]
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Computed missing_slots for first turn: intent=UNKNOWN, missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=UNKNOWN missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[PLAN_STATUS] user_id=test_session_045_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['error', 'message', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_045_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "",
    "facts": {
      "slots": {},
      "missing_slots": [],
      "context": {}
    },
    "booking": {},
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "UNKNOWN"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": []
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 1] user_id=test_session_045_bbfbce9e - CLEARED (status=READY)

--- Turn 2/3: book a haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_045_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_045_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_045_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_045_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 3/3: tomorrow at 10am ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_045_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_045_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14', 'time': '10:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'time'] = {'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date', 'time'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time'], promoted_slots=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['has_datetime', 'service_id', 'time', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'time', 'has_datetime']
  slots.time=10:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_045_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'time': '10:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'time', 'has_datetime']
  merged_session_slots.time=10:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=READY, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=READY, awaiting_slot=None, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_045_bbfbce9e plan_status=READY plan={
  "status": "READY",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_045_bbfbce9e plan_status=READY about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "READY",
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14",
        "time": "10:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "plan": {
      "status": "READY",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "10:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "time": "10:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=READY outcome_keys=['status', 'intent_name', 'facts', 'booking', 'plan']

[SESSION AFTER TURN 3] user_id=test_session_045_bbfbce9e - CLEARED (status=READY)

 Scenario 45 passed

============================================================
Scenario 46: intent_switch_resets_session
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_046_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_046_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: cancel my booking ---
Expected: {
  "intent": "CANCEL_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_046_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}
[PROMOTION] BEFORE promotion: intent=CANCEL_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=CANCEL_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=CANCEL_BOOKING
  required_slots_set={'booking_id'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CANCEL_BOOKING, missing_slots=['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[PLAN_STATUS] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "CANCEL_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {
      "booking_id": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id"
    ]
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {'booking_id': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_046_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 3/3: booking abc123 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_046_bbfbce9e
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_046_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: [] = {}
[DEBUG] Merge: session_slots={}
[DEBUG] Merge: merged_slots (after copy)={}
[DEBUG] Merge: merged_slots (after luma merge)={}
[DEBUG] Merge: merged_slots.keys()=[]
[SLOT_DURABILITY] merged_slots after merge: [] = {}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CANCEL_BOOKING, session_state=True, merged_slots.keys()=[]
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=[], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CANCEL_BOOKING, session_intent=CANCEL_BOOKING, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: []
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[INFORMATIONAL_TURN] Preserved missing_slots: ['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_046_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['booking_id'], slots_keys=[], booking_services=None
[PLAN_STATUS] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_046_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_046_bbfbce9e intent=CANCEL_BOOKING missing_slots_from_facts=['booking_id'] missing_slots_from_response=['booking_id'] final_missing_slots=['booking_id']
  facts_slots={} effective_response_slots={}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "booking_id"
        ],
        "filtered_missing_slots": [
          "booking_id"
        ],
        "slots_keys": [],
        "booking_has_services": false,
        "service_id_in_slots": false,
        "service_id_value": null
      }
    },
    "intent_name": "CANCEL_BOOKING",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "booking_id"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "missing_slots": [
      "booking_id"
    ],
    "_effective_collected_slots": {}
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {}, 'missing_slots': ['booking_id'], '_effective_collected_slots': {}}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_046_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "booking_id"
}

 Scenario 46 passed

============================================================
Scenario 47: intent_switch_modify_to_cancel
============================================================
Domain: service, Turns: 3

--- Turn 1/3: change booking ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_047_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_047_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_047_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_047_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_047_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_047_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_047_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 48: intent_switch_create_to_cancel
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book facial ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_048_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'facial'}
  effective_collected_slots (after filter)={'service_id': 'facial'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'facial'}
  effective_response.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context={'services': [{'canonical': 'facial', 'text': 'facial'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'facial'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "facial"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "facial",
            "text": "facial"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "facial",
          "text": "facial"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "facial"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "facial"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'facial', 'text': 'facial'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'facial'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'facial'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'facial'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'facial'}
[DEBUG] Persisting to session: slots={'service_id': 'facial'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_048_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: nevermind cancel ---
Expected: {
  "intent": "CANCEL_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_048_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "facial"
  },
  "status": "NEEDS_CLARIFICATION"
}
[PROMOTION] BEFORE promotion: intent=CANCEL_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=CANCEL_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=CANCEL_BOOKING
  required_slots_set={'booking_id'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CANCEL_BOOKING, missing_slots=['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[PLAN_STATUS] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "CANCEL_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {
      "booking_id": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id"
    ]
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {'booking_id': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_048_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 3/3: booking 999 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_048_bbfbce9e
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_048_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: [] = {}
[DEBUG] Merge: session_slots={}
[DEBUG] Merge: merged_slots (after copy)={}
[DEBUG] Merge: merged_slots (after luma merge)={}
[DEBUG] Merge: merged_slots.keys()=[]
[SLOT_DURABILITY] merged_slots after merge: [] = {}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CANCEL_BOOKING, session_state=True, merged_slots.keys()=[]
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=[], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CANCEL_BOOKING, session_intent=CANCEL_BOOKING, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: []
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[INFORMATIONAL_TURN] Preserved missing_slots: ['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_048_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['booking_id'], slots_keys=[], booking_services=None
[PLAN_STATUS] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_048_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_048_bbfbce9e intent=CANCEL_BOOKING missing_slots_from_facts=['booking_id'] missing_slots_from_response=['booking_id'] final_missing_slots=['booking_id']
  facts_slots={} effective_response_slots={}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "booking_id"
        ],
        "filtered_missing_slots": [
          "booking_id"
        ],
        "slots_keys": [],
        "booking_has_services": false,
        "service_id_in_slots": false,
        "service_id_value": null
      }
    },
    "intent_name": "CANCEL_BOOKING",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "booking_id"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "missing_slots": [
      "booking_id"
    ],
    "_effective_collected_slots": {}
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {}, 'missing_slots': ['booking_id'], '_effective_collected_slots': {}}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_048_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "booking_id"
}

 Scenario 48 passed

============================================================
Scenario 49: multi_turn_ambiguous_followup
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book waxing ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_049_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'waxing'}
  effective_collected_slots (after filter)={'service_id': 'waxing'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing'}
  effective_response.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing'}
  extraction_result.context={'services': [{'canonical': 'waxing', 'text': 'waxing'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "waxing"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "waxing",
            "text": "waxing"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "waxing",
          "text": "waxing"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "waxing"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "waxing"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'waxing', 'text': 'waxing'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'waxing'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'waxing'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'waxing'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'waxing'}
[DEBUG] Persisting to session: slots={'service_id': 'waxing'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_049_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: next week ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_049_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_049_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'waxing'}
[DEBUG] Merge: session_slots={'service_id': 'waxing'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'waxing'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range'] = {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range']
[PROMOTION] ADDED date from date_range: 2026-01-19
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range'], promoted_slots=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date_range', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date']
  promoted_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_collected_slots (after filter)={'service_id': 'waxing', 'date': '2026-01-19'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date'], promoted_slots=['service_id', 'date_range', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date_range', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date_range', 'date'], booking_services=[{'text': 'waxing'}]
[PLAN_STATUS] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_049_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'} effective_response_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  effective_response_booking_services=[{'text': 'waxing'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "waxing",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        },
        "date": "2026-01-19"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date_range",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "waxing"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "waxing",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      },
      "date": "2026-01-19"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "waxing",
      "date": "2026-01-19"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'waxing'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'waxing', 'date': '2026-01-19'}}
  slots from merged_luma_response={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
  slots.keys()=['service_id', 'date_range', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date'] = {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Persisting to session: slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_049_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: morning ---
Expected: {
  "status": "READY"
}

[SESSION BEFORE TURN 3] user_id=test_session_049_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_049_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '08:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date_range', 'date'] = {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: session_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date_range', 'date', 'time'] = {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date_range', 'date', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date_range', 'date', 'time'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time']
[PROMOTION] ADDED has_datetime (date + time present)
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Promotion: merged_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00'}
[DEBUG] Promotion: promoted_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  promoted_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  effective_collected_slots (after filter)={'service_id': 'waxing', 'date': '2026-01-19', 'time': '08:00'}
  effective_collected_slots.keys()=['service_id', 'date', 'time']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], promoted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], effective_collected=['service_id', 'date', 'time'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  slots.time=08:00
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[PRE_PLAN_DEBUG] user_id=test_session_049_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date_range', 'date', 'time', 'has_datetime']
  merged_session_slots.time=08:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=time is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'date_range', 'date', 'time', 'has_datetime'], booking_services=[{'text': 'waxing'}]
[PLAN_STATUS] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_049_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_049_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True} effective_response_slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  effective_response_booking_services=[{'text': 'waxing'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "waxing",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        },
        "date": "2026-01-19",
        "time": "08:00",
        "has_datetime": true
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "date_range",
          "date",
          "time",
          "has_datetime"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "waxing"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "waxing",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      },
      "date": "2026-01-19",
      "time": "08:00",
      "has_datetime": true
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "waxing"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "waxing",
      "date": "2026-01-19",
      "time": "08:00"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'waxing'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'waxing', 'date': '2026-01-19', 'time': '08:00'}}
  slots from merged_luma_response={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
  slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date_range', 'date', 'time', 'has_datetime'] = {'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots={'service_id': 'waxing', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}, 'date': '2026-01-19', 'time': '08:00', 'has_datetime': True}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date_range', 'date', 'time', 'has_datetime']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['time', 'has_datetime', 'date', 'date_range', 'service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date_range', 'date', 'time', 'has_datetime'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_049_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "waxing",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    },
    "date": "2026-01-19",
    "time": "08:00",
    "has_datetime": true
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

============================================================
Scenario 50: reservation_ambiguous_followup
============================================================
Domain: reservation, Turns: 4

--- Turn 1/4: book room ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_050_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'room'}
  effective_collected_slots (after filter)={'service_id': 'room'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'room'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "room"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "room"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "room"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "room"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "room"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'room'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'room'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'room'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'room'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'room'}
[DEBUG] Persisting to session: slots={'service_id': 'room'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_050_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/4: next month ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_050_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_050_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-02-12'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'room'}
[DEBUG] Merge: session_slots={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'date': '2026-02-12'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'room', 'date': '2026-02-12'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=None, 'date' in merged_slots=True
[RESERVATION_DATE_PROMOTION] Promoted date=2026-02-12 to start_date (removed generic 'date' slot, start_date was missing)
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['end_date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['end_date'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'start_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-02-12'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-02-12'}
  effective_collected_slots.keys()=['service_id', 'start_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date'], promoted_slots=['service_id', 'start_date'], effective_collected=['service_id', 'start_date'], missing_slots=['end_date']

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-02-12'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-02-12'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date'], filtered=['end_date'], slots_keys=['service_id', 'start_date']
[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-02-12'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=end_date, missing_slots=['end_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=['end_date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['end_date'], slots_keys=['service_id', 'start_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['end_date']
[PLAN_STATUS_CHECK] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_050_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=['end_date'] missing_slots_from_response=['end_date'] final_missing_slots=['end_date']
  facts_slots={'service_id': 'room', 'start_date': '2026-02-12'} effective_response_slots={'service_id': 'room', 'start_date': '2026-02-12'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_END_DATE",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_END_DATE",
      "missing": [
        "end_date"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-02-12"
      },
      "missing_slots": [
        "end_date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "end_date"
        ],
        "filtered_missing_slots": [
          "end_date"
        ],
        "slots_keys": [
          "service_id",
          "start_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "room",
      "start_date": "2026-02-12"
    },
    "status": "ready",
    "success": true,
    "context": {},
    "missing_slots": [
      "end_date"
    ],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-02-12"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'room', 'start_date': '2026-02-12'}, 'status': 'ready', 'success': True, 'context': {}, 'missing_slots': ['end_date'], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-02-12'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-02-12'}
  slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date'], missing_slots=['end_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_050_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-02-12"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

--- Turn 3/4: from the 1st ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_050_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-02-12"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

[RAW_LUMA_DEBUG] user_id=test_session_050_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Merge: session_slots={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'room', 'start_date': '2026-02-12'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'start_date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'start_date'] = {'service_id': 'room', 'start_date': '2026-02-12'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_RESERVATION, session_state=True, merged_slots.keys()=['service_id', 'start_date', 'date']
[AWAITING_SLOT_DEBUG] Reservation routing: awaiting_slot=end_date, 'date' in merged_slots=True
[AWAITING_SLOT_DEBUG] Routing condition met: awaiting_slot=end_date, date_value=2026-02-12, merged_slots before routing=['service_id', 'start_date', 'date']
[RESERVATION_DATE_ROUTING] Routed date=2026-02-12 to end_date (removed generic 'date' slot, cleared awaiting_slot)
[AWAITING_SLOT_DEBUG] After routing: awaiting_slot=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], routed_slot_value=2026-02-12, awaiting_slot in merged_slots=True, awaiting_slot in merged=None
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=end_date, merged_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged_slots=True, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id', 'start_date', 'end_date']
[DEBUG] Promotion: merged_slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
[DEBUG] Promotion: promoted_slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Slot promotion: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_RESERVATION, durable_slots.keys()=['service_id', 'start_date', 'end_date'], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_RESERVATION, durable_slots=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=[], awaiting_slot_in_merged=end_date, awaiting_slot_in_session=end_date, awaiting_slot_in_missing=False
[MISSING_SLOTS] Computed missing_slots: []
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=[], merged['awaiting_slot']=end_date, merged['slots'].keys()=['service_id', 'start_date', 'end_date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id', 'start_date', 'end_date']
  promoted_slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  effective_collected_slots (after filter)={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  effective_collected_slots.keys()=['service_id', 'start_date', 'end_date']
[MERGE] Computed missing_slots fresh: intent=CREATE_RESERVATION, raw_slots=['service_id', 'start_date', 'end_date'], promoted_slots=['service_id', 'start_date', 'end_date'], effective_collected=['service_id', 'start_date', 'end_date'], missing_slots=[]

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'start_date', 'end_date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=[], filtered=[], slots_keys=['service_id', 'start_date', 'end_date']
[PRE_PLAN_DEBUG] user_id=test_session_050_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'start_date', 'end_date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=[] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=READY (no missing slots, no clarification needed, no pending confirmation)
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=end_date, awaiting_slot_new=None, missing_slots=[], status=READY
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=end_date, status=READY, will_force_needs_clarification=True
[AWAITING_SLOT] Forcing status=NEEDS_CLARIFICATION because awaiting_slot=end_date is set (even though missing_slots is empty)
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=end_date, missing_slots=[]
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=[], slots_keys=['service_id', 'start_date', 'end_date'], booking_services=None
[PLAN_STATUS] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "end_date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=[]
[PLAN_STATUS_CHECK] user_id=test_session_050_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_050_bbfbce9e intent=CREATE_RESERVATION missing_slots_from_facts=[] missing_slots_from_response=[] final_missing_slots=[]
  facts_slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'} effective_response_slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {
        "service_id": "room",
        "start_date": "2026-02-12",
        "end_date": "2026-02-12"
      },
      "missing_slots": [],
      "context": {},
      "_debug": {
        "original_missing_slots": [],
        "filtered_missing_slots": [],
        "slots_keys": [
          "service_id",
          "start_date",
          "end_date"
        ],
        "booking_has_services": false,
        "service_id_in_slots": true,
        "service_id_value": "room"
      }
    },
    "intent_name": "CREATE_RESERVATION",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "end_date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {
      "service_id": "room",
      "start_date": "2026-02-12",
      "end_date": "2026-02-12"
    },
    "awaiting_slot": "end_date",
    "context": {},
    "missing_slots": [],
    "_effective_collected_slots": {
      "service_id": "room",
      "start_date": "2026-02-12",
      "end_date": "2026-02-12"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}, 'awaiting_slot': 'end_date', 'context': {}, 'missing_slots': [], '_effective_collected_slots': {'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}}
  slots from merged_luma_response={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
  slots.keys()=['service_id', 'start_date', 'end_date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'start_date', 'end_date'] = {'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
[DEBUG] Persisting to session: slots={'service_id': 'room', 'start_date': '2026-02-12', 'end_date': '2026-02-12'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'start_date', 'end_date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['end_date', 'start_date', 'service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: []
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id', 'start_date', 'end_date'], missing_slots=[]
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id', 'start_date', 'end_date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_050_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "room",
    "start_date": "2026-02-12",
    "end_date": "2026-02-12"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "end_date"
}

============================================================
Scenario 51: awaiting_time_rejects_date
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_051_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_051_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: tomorrow ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_051_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_051_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_051_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14'} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_051_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: next week ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_051_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

[RAW_LUMA_DEBUG] user_id=test_session_051_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: session_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date', 'date_range']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date', 'date_range'] = {'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date', 'date_range']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=time, merged_slots.keys()=['service_id', 'date', 'date_range'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date', 'date_range'], promoted_slots=['service_id', 'date', 'date_range']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date', 'date_range']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date', 'date_range']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'date_range'], promoted_slots=['service_id', 'date', 'date_range']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date', 'date_range'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date', 'date_range']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=time, awaiting_slot_in_session=time, awaiting_slot_in_missing=True
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'date_range']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=time, merged['slots'].keys()=['service_id', 'date', 'date_range']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date', 'date_range']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date', 'date_range'], promoted_slots=['service_id', 'date', 'date_range'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date', 'date_range']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date', 'date_range']
[PRE_PLAN_DEBUG] user_id=test_session_051_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date', 'date_range']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=time, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date', 'date_range'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_051_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_051_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14",
        "date_range": {
          "end": "2026-01-25",
          "start": "2026-01-19"
        }
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date",
          "date_range"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14",
      "date_range": {
        "end": "2026-01-25",
        "start": "2026-01-19"
      }
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "awaiting_slot": "time",
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'awaiting_slot': 'time', 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
  slots.keys()=['service_id', 'date', 'date_range']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date', 'date_range'] = {'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14', 'date_range': {'end': '2026-01-25', 'start': '2026-01-19'}}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date', 'date_range']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['date_range', 'service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date', 'date_range'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date', 'date_range'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_051_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14",
    "date_range": {
      "end": "2026-01-25",
      "start": "2026-01-19"
    }
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

 Scenario 51 passed

============================================================
Scenario 52: awaiting_date_rejects_time
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book massage at 3pm ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_052_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}
  context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  context.time_ref=3 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '15:00'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}
  context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  context.time_ref=3 pm
  context.time_mode=exact
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=15:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '15:00'}
  extraction_result.context.time_constraint={'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}
  extraction_result.context.time_mode=exact
  extraction_result.context.time_ref=3 pm
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=15:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_052_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_052_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "15:00",
        "label": null,
        "mode": "exact",
        "start": "15:00"
      },
      "time_mode": "exact",
      "time_ref": "3 pm"
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "15:00"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ],
        "time_constraint": {
          "end": "15:00",
          "label": null,
          "mode": "exact",
          "start": "15:00"
        },
        "time_mode": "exact",
        "time_ref": "3 pm"
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ],
      "time_constraint": {
        "end": "15:00",
        "label": null,
        "mode": "exact",
        "start": "15:00"
      },
      "time_mode": "exact",
      "time_ref": "3 pm"
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage",
      "time": "15:00"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}], 'time_constraint': {'end': '15:00', 'label': None, 'mode': 'exact', 'start': '15:00'}, 'time_mode': 'exact', 'time_ref': '3 pm'}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage', 'time': '15:00'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage', 'time': '15:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'massage', 'time': '15:00'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'time': '15:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_052_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "15:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: 5pm ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_052_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "15:00"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_052_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'time': '17:00'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id', 'time'] = {'service_id': 'massage', 'time': '15:00'}
[DEBUG] Merge: session_slots={'service_id': 'massage', 'time': '15:00'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage', 'time': '15:00'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage', 'time': '17:00'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'time'] = {'service_id': 'massage', 'time': '17:00'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'time']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'time'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CREATE_APPOINTMENT, session_intent=CREATE_APPOINTMENT, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: ['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[INFORMATIONAL_TURN] Preserved missing_slots: ['date']

[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage', 'time': '17:00'}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '17:00'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'time']
  slots.time=17:00
[FILTER_DEBUG] Pre-plan filtering: raw=['date'], filtered=['date'], slots_keys=['service_id', 'time']
[PRE_PLAN_DEBUG] user_id=test_session_052_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage', 'time': '17:00'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'time']
  merged_session_slots.time=17:00
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=date, missing_slots=['date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=date, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=date, missing_slots=['date']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['date'], slots_keys=['service_id', 'time'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_052_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "date"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['date']
[PLAN_STATUS_CHECK] user_id=test_session_052_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_052_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['date'] missing_slots_from_response=['date'] final_missing_slots=['date']
  facts_slots={'service_id': 'massage', 'time': '17:00'} effective_response_slots={'service_id': 'massage', 'time': '17:00'}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE",
    "template_key": "service.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "date"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage",
        "time": "17:00"
      },
      "missing_slots": [
        "date"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "date"
        ],
        "filtered_missing_slots": [
          "date"
        ],
        "slots_keys": [
          "service_id",
          "time"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "date"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "massage",
      "time": "17:00"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "missing_slots": [
      "date"
    ],
    "_effective_collected_slots": {
      "service_id": "massage",
      "time": "15:00"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'massage', 'time': '17:00'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'massage'}]}, 'missing_slots': ['date'], '_effective_collected_slots': {'service_id': 'massage', 'time': '15:00'}}
  slots from merged_luma_response={'service_id': 'massage', 'time': '17:00'}
  slots.keys()=['service_id', 'time']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'time'] = {'service_id': 'massage', 'time': '17:00'}
[DEBUG] Persisting to session: slots={'service_id': 'massage', 'time': '17:00'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'time']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'time'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'time'], missing_slots=['date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'time'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_052_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage",
    "time": "17:00"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "date"
}

 Scenario 52 passed

============================================================
Scenario 53: awaiting_slot_cleared_on_intent_switch
============================================================
Domain: service, Turns: 3

--- Turn 1/3: book haircut ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_053_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'haircut'}
  effective_collected_slots (after filter)={'service_id': 'haircut'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut'}
  effective_response.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context={'services': [{'canonical': 'haircut', 'text': 'haircut'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "haircut"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "haircut",
            "text": "haircut"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "haircut",
          "text": "haircut"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "haircut"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "haircut"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'haircut', 'text': 'haircut'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'haircut'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'haircut'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'haircut'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_053_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: tomorrow ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_053_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_053_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={'date': '2026-01-14'}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'haircut'}
[DEBUG] Merge: session_slots={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'haircut'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Merge: merged_slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] merged_slots after merge: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id', 'date']
[DEBUG] Promotion: merged_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Promotion: promoted_slots.keys()=['service_id', 'date']
[MERGE] Slot promotion: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date']
[AWAITING_SLOT_DEBUG] Before compute_missing_slots: effective_intent=CREATE_APPOINTMENT, durable_slots.keys()=['service_id', 'date'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None
[MISSING_SLOTS] Computing missing_slots: intent=CREATE_APPOINTMENT, durable_slots=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[AWAITING_SLOT_DEBUG] After compute_missing_slots: missing_slots=['time'], awaiting_slot_in_merged=None, awaiting_slot_in_session=None, awaiting_slot_in_missing=N/A
[MISSING_SLOTS] Computed missing_slots: ['time']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[AWAITING_SLOT_DEBUG] After setting missing_slots in merged: merged['missing_slots']=['time'], merged['awaiting_slot']=None, merged['slots'].keys()=['service_id', 'date']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id', 'date']
  promoted_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots (after filter)={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_collected_slots.keys()=['service_id', 'date']
[MERGE] Computed missing_slots fresh: intent=CREATE_APPOINTMENT, raw_slots=['service_id', 'date'], promoted_slots=['service_id', 'date'], effective_collected=['service_id', 'date'], missing_slots=['time']

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id', 'date']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['time'], filtered=['time'], slots_keys=['service_id', 'date']
[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'haircut', 'date': '2026-01-14'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id', 'date']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=time, missing_slots=['time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=time, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=time, missing_slots=['time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['time'], slots_keys=['service_id', 'date'], booking_services=[{'text': 'haircut'}]
[PLAN_STATUS] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "time"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['time']
[PLAN_STATUS_CHECK] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_053_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['time'] missing_slots_from_response=['time'] final_missing_slots=['time']
  facts_slots={'service_id': 'haircut', 'date': '2026-01-14'} effective_response_slots={'service_id': 'haircut', 'date': '2026-01-14'}
  effective_response_booking_services=[{'text': 'haircut'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "haircut",
        "date": "2026-01-14"
      },
      "missing_slots": [
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "time"
        ],
        "filtered_missing_slots": [
          "time"
        ],
        "slots_keys": [
          "service_id",
          "date"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "haircut"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "time"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    },
    "status": "ready",
    "success": true,
    "booking": {
      "services": [
        {
          "text": "haircut"
        }
      ]
    },
    "context": {},
    "missing_slots": [
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "haircut",
      "date": "2026-01-14"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'slots': {'service_id': 'haircut', 'date': '2026-01-14'}, 'status': 'ready', 'success': True, 'booking': {'services': [{'text': 'haircut'}]}, 'context': {}, 'missing_slots': ['time'], '_effective_collected_slots': {'service_id': 'haircut', 'date': '2026-01-14'}}
  slots from merged_luma_response={'service_id': 'haircut', 'date': '2026-01-14'}
  slots.keys()=['service_id', 'date']
[SLOT_DURABILITY] persisted session.slots: ['service_id', 'date'] = {'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots={'service_id': 'haircut', 'date': '2026-01-14'}
[DEBUG] Persisting to session: slots.keys()=['service_id', 'date']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id', 'date'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id', 'date'], missing_slots=['time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id', 'date'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_053_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}

--- Turn 3/3: cancel booking ---
Expected: {
  "intent": "CANCEL_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 3] user_id=test_session_053_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "haircut",
    "date": "2026-01-14"
  },
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "time"
}
[PROMOTION] BEFORE promotion: intent=CANCEL_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=CANCEL_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=CANCEL_BOOKING
  required_slots_set={'booking_id'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CANCEL_BOOKING, missing_slots=['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_053_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[PLAN_STATUS] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_053_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "CANCEL_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {
      "booking_id": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id"
    ]
  }
}

[OUTCOME STATUS] Turn 3 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {'booking_id': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 3] user_id=test_session_053_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

 Scenario 53 passed

============================================================
Scenario 54: awaiting_slot_not_used_for_modify_booking
============================================================
Domain: service, Turns: 2

--- Turn 1/2: change booking ---
Expected: {
  "intent": "MODIFY_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id",
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_054_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=MODIFY_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=MODIFY_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=MODIFY_BOOKING
  required_slots_set={'booking_id', 'date'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=MODIFY_BOOKING, missing_slots=['booking_id', 'date']

[PRE_PLAN_DEBUG] user_id=test_session_054_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_054_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id', 'date'], filtered=['booking_id', 'date'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_054_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=MODIFY_BOOKING missing_slots=['booking_id', 'date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id', 'date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['booking_id', 'date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['booking_id', 'date']
[PLAN_STATUS] user_id=test_session_054_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id', 'date']
[PLAN_STATUS_CHECK] user_id=test_session_054_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id",
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "MODIFY_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id",
        "date"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "intent": {
      "name": "MODIFY_BOOKING"
    },
    "issues": {
      "booking_id": "missing",
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id",
      "date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'intent': {'name': 'MODIFY_BOOKING'}, 'issues': {'booking_id': 'missing', 'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id', 'date']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=MODIFY_BOOKING, collected_slots=[], planning_required_slots=['booking_id', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id', 'date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=MODIFY_BOOKING, persisted_slots=[], missing_slots=['booking_id', 'date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=MODIFY_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_054_bbfbce9e - SAVED
  Session state: {
  "intent": "MODIFY_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

============================================================
Scenario 55: awaiting_slot_does_not_route_booking_id
============================================================
Domain: service, Turns: 2

--- Turn 1/2: book massage ---
Expected: {
  "intent": "CREATE_APPOINTMENT",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_055_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_APPOINTMENT, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_APPOINTMENT, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_APPOINTMENT
  required_slots_set={'service_id', 'time', 'date'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'massage'}
  effective_collected_slots (after filter)={'service_id': 'massage'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_APPOINTMENT, missing_slots=['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context={'services': [{'canonical': 'massage', 'text': 'massage'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[PLAN_STATUS] user_id=test_session_055_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_055_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_APPOINTMENT",
    "facts": {
      "slots": {
        "service_id": "massage"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {
        "services": [
          {
            "canonical": "massage",
            "text": "massage"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_TIME",
    "context": {
      "services": [
        {
          "canonical": "massage",
          "text": "massage"
        }
      ]
    },
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {
      "date": "missing",
      "time": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "massage"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "massage"
    },
    "missing_slots": [
      "date",
      "time"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_TIME', 'context': {'services': [{'canonical': 'massage', 'text': 'massage'}]}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {'date': 'missing', 'time': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'massage'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'massage'}, 'missing_slots': ['date', 'time']}
  slots from merged_luma_response={'service_id': 'massage'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Persisting to session: slots={'service_id': 'massage'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_055_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: booking 123 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "date",
    "time"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_055_bbfbce9e
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_055_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Merge: session_slots={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after copy)={'service_id': 'massage'}
[DEBUG] Merge: merged_slots (after luma merge)={'service_id': 'massage'}
[DEBUG] Merge: merged_slots.keys()=['service_id']
[SLOT_DURABILITY] merged_slots after merge: ['service_id'] = {'service_id': 'massage'}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CREATE_APPOINTMENT, session_state=True, merged_slots.keys()=['service_id']
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=['service_id'], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CREATE_APPOINTMENT, session_intent=CREATE_APPOINTMENT, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: ['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[INFORMATIONAL_TURN] Preserved missing_slots: ['date', 'time']

[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'massage'}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['date', 'time'], filtered=['date', 'time'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_055_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'massage'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_APPOINTMENT missing_slots=['date', 'time'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['date', 'time']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['date', 'time'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['date', 'time']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['date', 'time'], slots_keys=['service_id'], booking_services=[{'text': 'massage'}]
[PLAN_STATUS] user_id=test_session_055_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['date', 'time']
[PLAN_STATUS_CHECK] user_id=test_session_055_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_055_bbfbce9e intent=CREATE_APPOINTMENT missing_slots_from_facts=['date', 'time'] missing_slots_from_response=['date', 'time'] final_missing_slots=['date', 'time']
  facts_slots={'service_id': 'massage'} effective_response_slots={'service_id': 'massage'}
  effective_response_booking_services=[{'text': 'massage'}]

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_TIME",
    "template_key": "service.ask_time",
    "data": {
      "reason": "MISSING_TIME",
      "missing": [
        "date",
        "time"
      ],
      "ambiguous": []
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "facts": {
      "slots": {
        "service_id": "massage"
      },
      "missing_slots": [
        "date",
        "time"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "date",
          "time"
        ],
        "filtered_missing_slots": [
          "date",
          "time"
        ],
        "slots_keys": [
          "service_id"
        ],
        "booking_has_services": true,
        "service_id_in_slots": true,
        "service_id_value": "massage"
      }
    },
    "intent_name": "CREATE_APPOINTMENT",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": null
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CREATE_APPOINTMENT"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {
      "service_id": "massage"
    },
    "booking": {
      "services": [
        {
          "text": "massage"
        }
      ]
    },
    "missing_slots": [
      "date",
      "time"
    ],
    "_effective_collected_slots": {
      "service_id": "massage"
    }
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CREATE_APPOINTMENT'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {'service_id': 'massage'}, 'booking': {'services': [{'text': 'massage'}]}, 'missing_slots': ['date', 'time'], '_effective_collected_slots': {'service_id': 'massage'}}
  slots from merged_luma_response={'service_id': 'massage'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'massage'}
[DEBUG] Persisting to session: slots={'service_id': 'massage'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_APPOINTMENT, collected_slots=['service_id'], planning_required_slots=['service_id', 'time', 'date']
[MISSING_SLOTS] compute_missing_slots result: ['date', 'time']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_APPOINTMENT, persisted_slots=['service_id'], missing_slots=['date', 'time']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_APPOINTMENT, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_055_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_APPOINTMENT",
  "slots": {
    "service_id": "massage"
  },
  "status": "NEEDS_CLARIFICATION"
}

 Scenario 55 passed

============================================================
Scenario 56: booking_id_not_inferred_from_phrase
============================================================
Domain: service, Turns: 2

--- Turn 1/2: cancel my booking ---
Expected: {
  "intent": "CANCEL_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_056_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CANCEL_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=CANCEL_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=CANCEL_BOOKING
  required_slots_set={'booking_id'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CANCEL_BOOKING, missing_slots=['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[PLAN_STATUS] user_id=test_session_056_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_056_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "CANCEL_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {
      "booking_id": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {'booking_id': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_056_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: booking abc123 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_056_bbfbce9e
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_056_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: [] = {}
[DEBUG] Merge: session_slots={}
[DEBUG] Merge: merged_slots (after copy)={}
[DEBUG] Merge: merged_slots (after luma merge)={}
[DEBUG] Merge: merged_slots.keys()=[]
[SLOT_DURABILITY] merged_slots after merge: [] = {}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CANCEL_BOOKING, session_state=True, merged_slots.keys()=[]
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=[], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CANCEL_BOOKING, session_intent=CANCEL_BOOKING, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: []
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[INFORMATIONAL_TURN] Preserved missing_slots: ['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_056_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['booking_id'], slots_keys=[], booking_services=None
[PLAN_STATUS] user_id=test_session_056_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_056_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_056_bbfbce9e intent=CANCEL_BOOKING missing_slots_from_facts=['booking_id'] missing_slots_from_response=['booking_id'] final_missing_slots=['booking_id']
  facts_slots={} effective_response_slots={}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "service.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "booking_id"
        ],
        "filtered_missing_slots": [
          "booking_id"
        ],
        "slots_keys": [],
        "booking_has_services": false,
        "service_id_in_slots": false,
        "service_id_value": null
      }
    },
    "intent_name": "CANCEL_BOOKING",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "booking_id"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "missing_slots": [
      "booking_id"
    ],
    "_effective_collected_slots": {}
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {}, 'missing_slots': ['booking_id'], '_effective_collected_slots': {}}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_056_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "booking_id"
}

 Scenario 56 passed

============================================================
Scenario 57: booking_id_not_inferred_from_reservation_phrase
============================================================
Domain: reservation, Turns: 2

--- Turn 1/2: cancel reservation ---
Expected: {
  "intent": "CANCEL_BOOKING",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_057_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CANCEL_BOOKING, input_slots=[], promoted_slots=[]
[PROMOTION] AFTER promotion: intent=CANCEL_BOOKING, promoted_slots=[]
[DEBUG] Computing effective_collected_slots:
  effective_intent=CANCEL_BOOKING
  required_slots_set={'booking_id'}
  promoted_slots.keys()=[]
  promoted_slots={}
  effective_collected_slots (after filter)={}
  effective_collected_slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CANCEL_BOOKING, missing_slots=['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[PLAN_STATUS] user_id=test_session_057_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_057_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "MISSING_BOOKING_REFERENCE",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "context": {},
    "booking": {},
    "intent_name": "CANCEL_BOOKING",
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {}
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_BOOKING_REFERENCE",
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {
      "booking_id": "missing"
    },
    "needs_clarification": true,
    "status": "needs_clarification",
    "success": true,
    "slots": {},
    "_effective_collected_slots": {},
    "missing_slots": [
      "booking_id"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_BOOKING_REFERENCE', 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {'booking_id': 'missing'}, 'needs_clarification': True, 'status': 'needs_clarification', 'success': True, 'slots': {}, '_effective_collected_slots': {}, 'missing_slots': ['booking_id']}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_057_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/2: reservation xyz789 ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "booking_id"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_057_bbfbce9e
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION"
}

[RAW_LUMA_DEBUG] user_id=test_session_057_bbfbce9e RAW Luma response BEFORE merge:
  luma_response.slots={}
  luma_response.context={}
  booking.time_constraint=None
  booking.datetime_range=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  entities.times=None
  entities.time_windows=None
[SLOT_DURABILITY] session.slots before merge: [] = {}
[DEBUG] Merge: session_slots={}
[DEBUG] Merge: merged_slots (after copy)={}
[DEBUG] Merge: merged_slots (after luma merge)={}
[DEBUG] Merge: merged_slots.keys()=[]
[SLOT_DURABILITY] merged_slots after merge: [] = {}
[AWAITING_SLOT_DEBUG] Reservation routing check: intent=CANCEL_BOOKING, session_state=True, merged_slots.keys()=[]
[AWAITING_SLOT_DEBUG] Preserving awaiting_slot from session: awaiting_slot_from_session=None, merged_slots.keys()=[], awaiting_slot_in_merged_slots=False, awaiting_slot_already_in_merged=None
[INFORMATIONAL_TURN] Detected informational turn: luma_intent=CANCEL_BOOKING, session_intent=CANCEL_BOOKING, has_new_slots=False
[INFORMATIONAL_TURN] Preserved slots: []
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[INFORMATIONAL_TURN] Preserved missing_slots: ['booking_id']

[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={}
  effective_response.context={}
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context={}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=[]
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['booking_id'], filtered=['booking_id'], slots_keys=[]
[PRE_PLAN_DEBUG] user_id=test_session_057_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=[]
  merged_session_slots.time=None
[BUILD_PLAN] intent=CANCEL_BOOKING missing_slots=['booking_id'] needs_clarification=False confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['booking_id']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=booking_id, missing_slots=['booking_id'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=booking_id, status=NEEDS_CLARIFICATION, will_force_needs_clarification=False
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=booking_id, missing_slots=['booking_id']
[FILTER_DEBUG] Non-clarification path: filtered_missing_slots=['booking_id'], slots_keys=[], booking_services=None
[PLAN_STATUS] user_id=test_session_057_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": "booking_id"
}
[PLAN_STATUS] decision_keys=['intent_name', 'action_name', 'booking', 'plan', 'facts'] decision_facts_missing_slots=['booking_id']
[PLAN_STATUS_CHECK] user_id=test_session_057_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions
[SYNTHESIZE_CLARIFICATION] user_id=test_session_057_bbfbce9e intent=CANCEL_BOOKING missing_slots_from_facts=['booking_id'] missing_slots_from_response=['booking_id'] final_missing_slots=['booking_id']
  facts_slots={} effective_response_slots={}
  effective_response_booking_services=None

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "NEEDS_CLARIFICATION",
    "template_key": "reservation.clarify",
    "data": {
      "reason": "NEEDS_CLARIFICATION",
      "missing": [
        "booking_id"
      ],
      "ambiguous": []
    },
    "booking": null,
    "facts": {
      "slots": {},
      "missing_slots": [
        "booking_id"
      ],
      "context": {},
      "_debug": {
        "original_missing_slots": [
          "booking_id"
        ],
        "filtered_missing_slots": [
          "booking_id"
        ],
        "slots_keys": [],
        "booking_has_services": false,
        "service_id_in_slots": false,
        "service_id_value": null
      }
    },
    "intent_name": "CANCEL_BOOKING",
    "plan": {
      "status": "NEEDS_CLARIFICATION",
      "allowed_actions": [],
      "blocked_actions": [],
      "awaiting": null,
      "awaiting_slot": "booking_id"
    }
  },
  "_merged_luma_response": {
    "clarification_reason": null,
    "entities": {},
    "intent": {
      "name": "CANCEL_BOOKING"
    },
    "issues": {},
    "needs_clarification": false,
    "status": "ready",
    "success": true,
    "slots": {},
    "missing_slots": [
      "booking_id"
    ],
    "_effective_collected_slots": {}
  }
}

[OUTCOME STATUS] Turn 2 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'booking', 'facts', 'intent_name', 'plan']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': None, 'entities': {}, 'intent': {'name': 'CANCEL_BOOKING'}, 'issues': {}, 'needs_clarification': False, 'status': 'ready', 'success': True, 'slots': {}, 'missing_slots': ['booking_id'], '_effective_collected_slots': {}}
  slots from merged_luma_response={}
  slots.keys()=[]
[SLOT_DURABILITY] persisted session.slots: [] = {}
[DEBUG] Persisting to session: slots={}
[DEBUG] Persisting to session: slots.keys()=[]
[MISSING_SLOTS] compute_missing_slots: intent=CANCEL_BOOKING, collected_slots=[], planning_required_slots=['booking_id']
[MISSING_SLOTS] compute_missing_slots result: ['booking_id']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CANCEL_BOOKING, persisted_slots=[], missing_slots=['booking_id']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CANCEL_BOOKING, slots=[], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 2] user_id=test_session_057_bbfbce9e - SAVED
  Session state: {
  "intent": "CANCEL_BOOKING",
  "slots": {},
  "status": "NEEDS_CLARIFICATION",
  "awaiting_slot": "booking_id"
}

 Scenario 57 passed

============================================================
Scenario 58: end_date_not_inferred_from_second_date
============================================================
Domain: reservation, Turns: 3

--- Turn 1/3: reserve suite ---
Expected: {
  "intent": "CREATE_RESERVATION",
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "start_date",
    "end_date"
  ]
}

[SESSION BEFORE TURN 1] user_id=test_session_058_bbfbce9e
  Session state: None (no session found)
[PROMOTION] BEFORE promotion: intent=CREATE_RESERVATION, input_slots=['service_id'], promoted_slots=['service_id']
[PROMOTION] AFTER promotion: intent=CREATE_RESERVATION, promoted_slots=['service_id']
[DEBUG] Computing effective_collected_slots:
  effective_intent=CREATE_RESERVATION
  required_slots_set={'end_date', 'start_date', 'service_id'}
  promoted_slots.keys()=['service_id']
  promoted_slots={'service_id': 'suite'}
  effective_collected_slots (after filter)={'service_id': 'suite'}
  effective_collected_slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Computed missing_slots for first turn: intent=CREATE_RESERVATION, missing_slots=['end_date', 'start_date']

[PRE_PLAN_DEBUG] user_id=test_session_058_bbfbce9e BEFORE process_luma_response:
  effective_response.slots={'service_id': 'suite'}
  effective_response.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  stages.semantic.resolved_booking.time_constraint=None
  stages.semantic.resolved_booking.time_mode=None
  stages.semantic.resolved_booking.time_refs=None

[PRE_PLAN_DEBUG] user_id=test_session_058_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context={'services': [{'canonical': 'room', 'text': 'suite'}]}
  context.time_constraint=None
  context.time_ref=None
  context.time_mode=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots (after normalization)=['service_id']
  slots.time=None
[FILTER_DEBUG] Pre-plan filtering: raw=['end_date', 'start_date'], filtered=['end_date', 'start_date'], slots_keys=['service_id']
[PRE_PLAN_DEBUG] user_id=test_session_058_bbfbce9e RIGHT BEFORE build_plan:
  extraction_result.slots={'service_id': 'suite'}
  extraction_result.context.time_constraint=None
  extraction_result.context.time_mode=None
  extraction_result.context.time_ref=None
  trace.semantic.time_constraint=None
  trace.semantic.time_mode=None
  merged_session_slots_after_normalization=['service_id']
  merged_session_slots.time=None
[BUILD_PLAN] intent=CREATE_RESERVATION missing_slots=['end_date', 'start_date'] needs_clarification=True confirmation_state=None
[BUILD_PLAN] Setting status=NEEDS_CLARIFICATION because missing_slots=['end_date', 'start_date']
[AWAITING_SLOT_DEBUG] Before status check: awaiting_slot_from_session=None, awaiting_slot_new=None, missing_slots=['end_date', 'start_date'], status=NEEDS_CLARIFICATION
[AWAITING_SLOT_DEBUG] effective_awaiting_slot=None, status=NEEDS_CLARIFICATION, will_force_needs_clarification=None
[AWAITING_SLOT_DEBUG] Final plan: status=NEEDS_CLARIFICATION, awaiting_slot=None, missing_slots=['end_date', 'start_date']
[PLAN_STATUS] user_id=test_session_058_bbfbce9e plan_status=NEEDS_CLARIFICATION plan={
  "status": "NEEDS_CLARIFICATION",
  "allowed_actions": [],
  "blocked_actions": [],
  "awaiting": null,
  "awaiting_slot": null
}
[PLAN_STATUS] decision_keys=['outcome', 'plan', 'facts'] decision_facts_missing_slots=['end_date', 'start_date']
[PLAN_STATUS_CHECK] user_id=test_session_058_bbfbce9e plan_status=NEEDS_CLARIFICATION about to check plan_status conditions

Result:
{
  "success": true,
  "outcome": {
    "status": "NEEDS_CLARIFICATION",
    "clarification_reason": "MISSING_DATE_RANGE",
    "template_key": "reservation.ask_date",
    "data": {
      "reason": "MISSING_DATE",
      "missing": [
        "end_date",
        "start_date"
      ],
      "ambiguous": []
    },
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "booking": {},
    "intent_name": "CREATE_RESERVATION",
    "facts": {
      "slots": {
        "service_id": "suite"
      },
      "missing_slots": [
        "end_date",
        "start_date"
      ],
      "context": {
        "services": [
          {
            "canonical": "room",
            "text": "suite"
          }
        ]
      }
    }
  },
  "_merged_luma_response": {
    "clarification_reason": "MISSING_DATE",
    "context": {
      "services": [
        {
          "canonical": "room",
          "text": "suite"
        }
      ]
    },
    "intent": {
      "name": "CREATE_RESERVATION"
    },
    "issues": {
      "end_date": "missing",
      "start_date": "missing"
    },
    "needs_clarification": true,
    "slots": {
      "service_id": "suite"
    },
    "status": "needs_clarification",
    "success": true,
    "_effective_collected_slots": {
      "service_id": "suite"
    },
    "missing_slots": [
      "end_date",
      "start_date"
    ]
  }
}

[OUTCOME STATUS] Turn 1 outcome_status=NEEDS_CLARIFICATION outcome_keys=['status', 'clarification_reason', 'template_key', 'data', 'context', 'booking', 'intent_name', 'facts']
[DEBUG] build_session_state_from_outcome:
  merged_luma_response type: <class 'dict'>
  merged_luma_response={'clarification_reason': 'MISSING_DATE', 'context': {'services': [{'canonical': 'room', 'text': 'suite'}]}, 'intent': {'name': 'CREATE_RESERVATION'}, 'issues': {'end_date': 'missing', 'start_date': 'missing'}, 'needs_clarification': True, 'slots': {'service_id': 'suite'}, 'status': 'needs_clarification', 'success': True, '_effective_collected_slots': {'service_id': 'suite'}, 'missing_slots': ['end_date', 'start_date']}
  slots from merged_luma_response={'service_id': 'suite'}
  slots.keys()=['service_id']
[SLOT_DURABILITY] persisted session.slots: ['service_id'] = {'service_id': 'suite'}
[DEBUG] Persisting to session: slots={'service_id': 'suite'}
[DEBUG] Persisting to session: slots.keys()=['service_id']
[MISSING_SLOTS] compute_missing_slots: intent=CREATE_RESERVATION, collected_slots=['service_id'], planning_required_slots=['end_date', 'start_date', 'service_id']
[MISSING_SLOTS] compute_missing_slots result: ['end_date', 'start_date']
[MISSING_SLOTS] Recomputed missing_slots from persisted slots: intent=CREATE_RESERVATION, persisted_slots=['service_id'], missing_slots=['end_date', 'start_date']
[BUILD_SESSION] Built session state (missing_slots NOT persisted): intent=CREATE_RESERVATION, slots=['service_id'], status=NEEDS_CLARIFICATION

[SESSION AFTER TURN 1] user_id=test_session_058_bbfbce9e - SAVED
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}

--- Turn 2/3: from nov 1st ---
Expected: {
  "status": "NEEDS_CLARIFICATION",
  "missing_slots": [
    "end_date"
  ]
}

[SESSION BEFORE TURN 2] user_id=test_session_058_bbfbce9e
  Session state: {
  "intent": "CREATE_RESERVATION",
  "slots": {
    "service_id": "suite"
  },
  "status": "NEEDS_CLARIFICATION"
}
